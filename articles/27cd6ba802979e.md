---
title: "ã‚¼ãƒ­ã‹ã‚‰å­¦ã¶ AWS Distro for OpenTelemetry ã€œè‡ªå‹•è¨ˆè£…"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","ADOT","OpenTelemetry"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

æœ€è¿‘ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯åˆ†æ•£ãŒå½“ãŸã‚Šå‰ã«ãªã‚Šã¾ã—ãŸã€‚Ops ã«é–¢ã‚ã‚‹äººé–“ã¨ã—ã¦æ€ã†ã“ã¨ã¯ã€å¾“æ¥ã®ãƒ­ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã ã‘å–å¾—ã—ã¦ã„ã‚‹ç›£è¦–ã§ã¯ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å¿œãŒé›£ã—ã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ä½•ã‚‰ã‹ã® APM ã‚’å°å…¥ã—ã¦è¿½è·¡å¯èƒ½ãªçŠ¶æ…‹ã«ã—ã¦ãŠãã“ã¨ãŒå¿…é ˆã§ã™ã€‚    

ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›ã¯ AWS Distro for OpenTelemetry (ä»¥ä¸‹ã€ADOT) ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚  

## ADOT ã¨ã¯

AWS ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ OpenTelemetry ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ãªã©ã‚’åé›†ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (AWS ã‚µãƒ¼ãƒ“ã‚¹ã‚„ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£) ã¸é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã‚’æä¾›ã—ã¾ã™ã€‚  
ã¾ãŸã€AWS ãƒªã‚½ãƒ¼ã‚¹ã‚„ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®è¦ªå’Œæ€§ãŒé«˜ãã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®åé›†ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚  

ADOT ã«å«ã¾ã‚Œã¦ã„ã‚‹ä¸»ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä»¥ä¸‹ã§ã™ã€‚  

- SDK
- è‡ªå‹•è¨ˆè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
- ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼

![img](https://aws-otel.github.io/static/img18-d16285359fd80134740fef110ac4f867.png)  
*https://aws-otel.github.io/docs/introduction*


## è‡ªå‹•è¨ˆè£…ã‚’ã‚„ã£ã¦ã¿ãŸ

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹è‡ªå‹•è¨ˆè£…ã‚’ã‚„ã£ã¦ã¿ã¾ã™ã€‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¨ˆè£…ã¯ã¾ãŸå¾Œæ—¥ã€‚  
EC2 ä¸Šã® JAVA ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å…¥ã‚Œã¦èµ·å‹•ã•ã›ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ CloudWatch ã¸é€ä¿¡ã—ã¾ã™ã€‚  

![img](/images/adot_cwagent.drawio.png)

### CloudWatch Agent

ä»Šå›ã¯ CloudWatch Agent ã‚’ä½¿ã„ã¾ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ AWS ãƒªã‚½ãƒ¼ã‚¹ã§åé›†ã—ãŸãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ CloudWatch ã«é€ä¿¡ã™ã‚‹ãŸã‚ã® CloudWatch Agent ã§ã™ã€‚  

ADOT ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’åˆ¥é€”æ§‹ç¯‰ã—ãŸã»ã†ãŒ OpenTelemetry ã®å…¨ã¦ã‚’å¼•ãå‡ºã›ã‚‹ã¯ãšã§ã™ãŒã€ä»Šå›ã¯ CloudWatch ã«ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã ã‘ãªã®ã§ CloudWatch Agent ã‚’é¸æŠã—ã¾ã—ãŸã€‚(æœ¬å½“ã¯å€‹äººçš„ã«ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸã ã‘)  

CloudWatch Agent ã®åˆ©ç‚¹ã¯ã€ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ã®3ç‚¹ã‚»ãƒƒãƒˆã‚’åé›†ã§ãã‚‹ã¨ã“ã‚ã§ã™ã€‚  

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

ã¾ãšã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚æ‰‹é †ã¯ä»¥ä¸‹ã‚’å‚ç…§ãã ã•ã„ã€‚  
[Create IAM roles and users for use with CloudWatch agent](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-iam-roles-for-cloudwatch-agent-commandline.html)  

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« (IAM ãƒ­ãƒ¼ãƒ«) ã«ã¯ä»¥ä¸‹3ã¤ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚  

- AWSXRayDaemonWriteAccess
- CloudWatchAgentServerPolicy
- AmazonSSMManagedInstanceCore

#### CloudWatch Agent ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

CloudWatch Agent ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚éå»ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚‚æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚OpenTelemetry ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ Version 1.300025.0 ä»¥é™ãŒå¿…è¦ã§ã™ã€‚  

Amazon Linux 2 ã®å ´åˆã¯ yum ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  

```bash
sudo yum install amazon-cloudwatch-agent
```

ãã®ä»–è©³ã—ã„ã“ã¨ã¯ [Installing the CloudWatch agent](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-on-EC2-Instance.html) ã‚’å‚ç…§ãã ã•ã„ã€‚    


#### æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨èª­ã¿è¾¼ã¿

CloudWatch Agent æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  
`traces` é …ç›®ãŒãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚  

`cw-agent.json` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ä»¥ä¸‹ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚  
ãƒ­ã‚°ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚å–å¾—ã—ãŸã„å ´åˆã¯ [Manually create or edit the CloudWatch agent configuration file](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html) ã‚’å‚ç…§ã—ã¦ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚  

```json:cw-agent.json
{
  "agent": {
    "logfile": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log",
    "region": "us-west-2"
  },
  "traces": {
    "traces_collected": {
      "otlp": {
        "grpc_endpoint": "127.0.0.1:4317",
        "http_endpoint": "127.0.0.1:4318"
      }
    }
  }
}
```

æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ CloudWatch Agent ã«èª­ã¿è¾¼ã¾ã›ã¾ã™ã€‚  

```bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:cw-agent.json 
```

ä»Šå›ã¯1å°ãªã®ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸãŒã€å°æ•°ãŒå¤šã„å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ã§ã™ã€‚  
[Installing the CloudWatch agent on EC2 instances using your agent configuration](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-on-EC2-Instance-fleet.html)  


å¿µã®ãŸã‚ã€netstat ã‚’æ‰“ã£ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæº–å‚™ OK ãªã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚  

```bash
$ netstat -ant

Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 127.0.0.1:4318          0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:4317          0.0.0.0:*               LISTEN   
```


### ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

OpenTelemetry ã®ã‚µã‚¤ãƒˆã«ã‚ã‚‹ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
[Getting Started](https://opentelemetry.io/docs/instrumentation/java/getting-started/)  

ä¸Šã®ã‚µã‚¤ãƒˆã«ã‚ã‚‹3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¾ã™ã€‚  

- build.gradle.kts
- DiceApplication.java
- RollController.java

### è‡ªå‹•è¨ˆè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

[aws-otel-java-instrumentation](https://github.com/aws-observability/aws-otel-java-instrumentation/releases) ã‹ã‚‰æœ€æ–°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚    
build.gradle.kts ã«æ¬¡ã®1è¡Œã‚’è¿½åŠ ã—ã¾ã™ã€‚ `implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")`  

```text:build.gradle.kts
plugins {
  id("java")
  id("org.springframework.boot") version "3.0.6"
  id("io.spring.dependency-management") version "1.1.0"
}

sourceSets {
  main {
    java.setSrcDirs(setOf("."))
  }
}

repositories {
  mavenCentral()
}

dependencies {
  implementation("org.springframework.boot:spring-boot-starter-web")
  implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")
}
```

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`-javaagent` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã® jar ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚  

```bash
gradle assemble

OTEL_METRICS_EXPORTER=none \
OTEL_RESOURCE_ATTRIBUTES="service.name=dice-server" \
java -javaagent:./aws-opentelemetry-agent.jar -jar ./build/libs/java-simple.jar
```

èµ·å‹•ã—ã¾ã—ãŸã€‚ã€Œopentelemetry-javaagent - version: 1.31.0-awsã€ã¨ã‚ã‚‹ã®ã§æ„å›³é€šã‚Šã«å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚  

```
BUILD SUCCESSFUL in 3s
4 actionable tasks: 4 executed
OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
[otel.javaagent 2023-11-07 05:21:16:255 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: 1.31.0-aws
2023-11-07T05:21:22.314Z  INFO 7881 --- [           main] otel.DiceApplication                     : Starting DiceApplication using Java 21.0.1 with PID 7881 
```

å‹•ä½œç¢ºèªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã¨ 1~6 ã®æ•°å­—ãŒãƒ©ãƒ³ãƒ€ãƒ ã§è¿”ã£ã¦ãã¾ã™ã€‚æ•°å›æ‰“ã£ã¦ã¿ã¾ã™ã€‚  

```
curl http://localhost:8080/rolldice
```

### CloudWatch 

ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ CloudWatch ã§ç¢ºèªã—ã¾ã™ã€‚  
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ CloudWatch ç”»é¢ã‚’é–‹ãã¾ã™ã€‚  

#### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

å·¦ãƒšã‚¤ãƒ³ã® `X-Ray ãƒˆãƒ¬ãƒ¼ã‚¹` â†’ `ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—` ã‚’é–‹ãã¾ã™ã€‚  
ãƒãƒƒãƒ—ã« EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é¸æŠã— **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  

ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ã”ã¨ã€ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã£ã½ã„æ„Ÿã˜ã§ã™ã€‚  

![trace](/images/xray_dashboard_1.png)

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã¯ EC2 æ¨™æº–ã§å–å¾—ã—ã¦ã„ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã™ã€‚OpenTelemetry ã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  

![trace](/images/xray_dashboard_2.png)


#### ãƒˆãƒ¬ãƒ¼ã‚¹

å·¦ãƒšã‚¤ãƒ³ã® `X-Ray ãƒˆãƒ¬ãƒ¼ã‚¹` â†’ `ãƒˆãƒ¬ãƒ¼ã‚¹` ã‚’é–‹ãã¾ã™ã€‚  
curl ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ãŸæ•°ã ã‘ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚  

![trace](/images/xray_traces.png)

ä»»æ„ã® ID ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  

![trace](/images/xray_trace_1.png)  

### ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

æ€ã£ã¦ãŸã‚ˆã‚Šç°¡å˜ã« OpenTelemetry ã«ã‚ˆã‚‹ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¨ˆè£…ã§ãã¾ã—ãŸã€‚  
è‡ªå‹•è¨ˆè£…ã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯é‹ç”¨ã§ä½¿ç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚ãŸã ã€ã‚‚ã†å°‘ã—è©³ã—ããƒ‡ãƒãƒƒã‚°ã—ãŸã„ã¨æ„Ÿã˜ã¾ã™ã€‚  
ãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã« span ã‚’å–ã£ã¦ã¿ã¾ã™ã€‚  

è‡ªå‹•è¨ˆè£…ã§ span ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ `opentelemetry-instrumentation-annotations` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã„ã¾ã™ã€‚  

build.gradle.kts ã«ã¾ãŸã¾ãŸ1è¡Œã‚’è¿½åŠ ã—ã¾ã™ã€‚

```text:build.gradle.kts
plugins {
  id("java")
  id("org.springframework.boot") version "3.0.6"
  id("io.spring.dependency-management") version "1.1.0"
}

sourceSets {
  main {
    java.setSrcDirs(setOf("."))
  }
}

repositories {
  mavenCentral()
}

dependencies {
  implementation("org.springframework.boot:spring-boot-starter-web")
  implementation("io.opentelemetry.instrumentation:opentelemetry-instrumentation-annotations:1.31.0")
  implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")
}
```

ã•ã‚‰ã«ã€ã‚³ãƒ¼ãƒ‰ã«ã‚‚ `import` ã¨ `@WithSpan` ã‚’è¿½åŠ ã—ã¾ã™ã€‚  
RollController.java ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚  

```java:RollController.java
package otel;

import java.util.Optional;
import java.util.concurrent.ThreadLocalRandom;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import io.opentelemetry.instrumentation.annotations.WithSpan;


@RestController
public class RollController {
  private static final Logger logger = LoggerFactory.getLogger(RollController.class);

  @WithSpan
  @GetMapping("/rolldice")
  public String index(@RequestParam("player") Optional<String> player) {
    int result = this.getRandomNumber(1, 6);
    if (player.isPresent()) {
      logger.info("{} is rolling the dice: {}", player.get(), result);
    } else {
      logger.info("Anonymous player is rolling the dice: {}", result);
    }
    return Integer.toString(result);
  }

  @WithSpan
  public int getRandomNumber(int min, int max) {
    return ThreadLocalRandom.current().nextInt(min, max + 1);
  }
}
```

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œã—ã¾ã™ã€‚å‹•ä½œç¢ºèªç”¨ã® curl ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¡ã¾ã™ã€‚  
CloudWatch ç”»é¢ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ã•ãã»ã©ã¨é•ã£ã¦ span (æ£’ç·š) ãŒå¢—ãˆã¦ã„ã¾ã™ã€‚`@WithSpan` ã‚’è¨˜è¿°ã—ãŸç®‡æ‰€ã§ã™ã­ã€‚    

![trace](/images/xray_trace_span.png)

### ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°

ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯äºˆæœŸã›ã¬å•é¡Œã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«æ¬ ã‹ã›ã¾ã›ã‚“ã€‚  
ãŸã ã€å½“ç„¶ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚CloudWatch ã«ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚Œã°å¾“é‡åˆ¶ã§æ–™é‡‘ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã€‚  

æœ¬ç•ªç’°å¢ƒã§ã¯ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šæ¸›ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’é–“å¼•ã„ã¦ CloudWatch ã¸é€ä¿¡ã™ã‚‹ã‚ã‘ã§ã™ã€‚
ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¯ç¢ºç‡ã§æ±ºå®šã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã®ã‚ã‚‹ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’é€ƒã—ã¦ã—ã¾ã†æ¬ ç‚¹ã¯ã‚ã‚Šã¾ã™ã€‚    
`OTEL_TRACES_SAMPLER=parentbased_traceidratio` ã¨ `OTEL_TRACES_SAMPLER_ARG=0.3` ã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ã€‚
0.3 ã¯ 30% ã¨ã„ã†æ„å‘³ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§˜å­ã‚’è¦‹ãªãŒã‚‰å¢—æ¸›ã•ã›ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ç‡ã®ä½ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒã‚·ãƒ“ã‚¢ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©æ§˜ã€…ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚  

è©³ç´°ãªèª¬æ˜ã¯ [Sampling](https://opentelemetry.io/docs/concepts/sampling/) ã‚’ã”è¦§ãã ã•ã„ã€‚ãƒ†ãƒ¼ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¨ã„ã†ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚   


## å‚è€ƒ

[About AWS Distro for OpenTelemetry](https://aws-otel.github.io/about)  
[AWS Distro for OpenTelemetry Documentation](https://aws-otel.github.io/docs/introduction)  
[GitHub aws-observability](https://github.com/aws-observability)  
[AWS Observability Best Practices](https://aws-observability.github.io/observability-best-practices/)  
