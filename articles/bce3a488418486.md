---
title: "1人SREが朝一ダッシュボードチェックをAIに手伝ってもらいたいのでPoCしている話"
emoji: "📑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AI", "SRE", "AIOps"]
published: true
---
こんにちは。  
ご機嫌いかがでしょうか。  
"No human labor is no human error" が大好きな[吉井 亮](https://twitter.com/YoshiiRyo1)です。  

プロダクトの規模が小さいと1人 SRE という体制は珍しくないと思います。  
1人で何が辛いかというと、相談相手やレビュー相手がいないことです。ですので、最近は AI/LLM に相手をしてもらっています。
運用に使っている Lambda 関数や Terraform のコードをレビューしてみたり（※1）、エラー発生時の1次対応をお願いしてみたり（※2）しています。  
※1 [プルリクしたら Bedrock にコードレビューしてもらいたい](https://zenn.dev/ryoyoshii/articles/b394253dd09d0a)  
※2 [AIOps入門 AWS Bedrock で障害分析](https://zenn.dev/ryoyoshii/articles/2617569c17538e)  

私は毎朝のタスクとして、ダッシュボードチェックを行っています。  
平日なら前日分、土日祝日なら2〜3日分のメトリクスを眺めながら、異常な挙動はないか、パフォーマンス劣化が起きていないかなどの確認をしています。
ただ、1人 SRE の朝一ダッシュボードチェックを以下の心配があります。  

- 何の問題もなければ地味で単調なタスクなので、気を抜くと兆候を見逃してしまう可能性は排除できない
- 1人だと考察に多様性が無い
- なにより1人だと飽きてしまう

というころで、朝一ダッシュボードチェックも AI/LLM に手伝ってもらうことにしました。PoC を開始します。  

## 構成

システムは AWS 上に構築しています。  

![img](/images/bce3a488418486.png)

### 構成図（１）

朝一ダッシュボードの相談をしたい場合は、Lambda 関数を呼び出します。  

Lambda 関数ではまず DynamoDB からパラメータを取得します。次のステップで CloudWatch の `GetMetricData` API を呼び出しているのですが、これに与えるパラメータを格納しています。  

例えば、ALB Target Response Time メトリクスなら以下のようなアイテムを DynamoDB に格納しています。CloudWatch メトリクスの画面やユーザーガイドを見ながらパラメータを決めます。  

:::details クリックして展開
```
{
  "awsService": {
    "S": "ALB_TARGET"
  },
  "dateRange": {
    "S": "7"
  },
  "namespace": {
    "S": "AWS/ApplicationELB"
  },
  "metricName": {
    "S": "TargetResponseTime"
  },
  "dimensionsName": {
    "S": "LoadBalancer"
  },
  "dimensionsValue": {
    "S": "your-load-balancer"
  },
  "period": {
    "S": "300"
  },
  "stat": {
    "S": "p90"
  },
  "unit": {
    "S": "Seconds"
  }
}
```
:::

### 構成図（２）

CloudWatch からメトリクスを取得しています。ここはオブザーバビリティ系 SaaS、Prometheus、Grafana ファミリーなどメトリクスデータソースは問いません。  

例として、以下のメトリクスを取得します。プロダクトによってダッシュボードの構成は違うと思います。ここは SRE の腕の見せどころですね。  

- ALB リクエスト数
- ALB ターゲットレスポンスタイム
- Aurora DML レイテンシー
- Aurora Select レイテンシー

ここで取得したメトリクスを次のステップで AI/LLM に投げます。ただ、`GetMetricData` API のレスポンスをそのまま投げてもノイズになるだけなので、タイムスタンプと値だけを取り出し、JSON に整形しています。  

### 構成図（３）

Amazon Bedrock [Converse](https://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_Converse.html) API を呼び出します。
Converse はどのモデルを利用するにしても一貫したインターフェイスを提供しているということで、モデル変更が柔軟になるだろうという期待で採用しています。  

API で指定しているシステムは以下です。役割を決めてあげると精度が上がるようです。  

```text
あなたはスマートフォンアプリ開発を行っているチームに所属しているシニアSREエンジニアです。
あなたのタスクのうちの1つに、アプリケーションのパフォーマンス悪化や障害の検知や予防があります。
様々なメトリクスデータをタイムスタンプで関連付けたうえで総合的に分析し、以下の観点で報告をお願いします。
ALBリクエスト数増加によりレスポンスやレイテンシーに影響が出ることが予想されます。リクエスト数あたりのレスポンスタイムやレイテンシーの変化を検知し、その影響を分析してください。

# 観点
- パフォーマンスの悪化やその兆候を検知する
	- 緩やかに数値が悪化しているケースが特に重要
- 障害の発生や疑わしさを検知する
	- メトリクスデータが急激に変動しているケース
	- メトリクスデータが急に欠落しているケース
- 期間中にメトリクスデータの極端な上下変動があれば報告する
	- 1時間で5%%程度の変動なら無視する

# メトリクスデータの説明
取得するメトリクスデータの種類とその説明を以下に示します。

## ALBリクエスト数
IPv4 および IPv6 経由で処理されたリクエストの数。このメトリックは、ロードバランサノードがターゲットを選択できたリクエストに対してのみ増加します。ターゲットが選択される前に拒否されたリクエストは、このメトリックに反映されません。

## ALBターゲットレスポンスタイム
リクエストがロードバランサーを離れ、ターゲットが応答ヘッダーの送信を開始するまでの経過時間 (秒)。

## Aurora DMLレイテンシー
データベースクラスターに対する挿入、更新、削除の平均時間（ミリ秒）。

## Aurora Selectレイテンシー
データベースクラスターに対する select クエリの平均時間（ミリ秒）。

# 報告形式
報告はマークダウン形式でお願いします。箇条書きで要点をまとめ、根拠となるデータを示してください。
可能な限り、推測はさけデータに基づいた事実だけを報告してください。
報告は日本語で1000文字以内にまとめてください。
```

メッセージは以下です。`%s` には Lambda 関数で取得したメトリクスデータを代入します。  

```text
# ALB リクエスト数
%s

# ALB ターゲットレスポンスタイムのメトリクスデータ
%s

# Aurora DML レイテンシーのメトリクスデータ
%s

# Aurora Select レイテンシーのメトリクスデータ
%s
```


## レスポンス

AI/LLM からのレスポンスは以下のようになりました。（抜粋です）  
事実に基づいたレスポンスだと感じました。平常ではない時間帯を発見してくれています。

```
# パフォーマンス分析レポート

## 重大な異常検知
1. ALBターゲットレスポンスタイムの急激な上昇
  - 2025-01-23 13:55に0.245秒(通常の約10倍)
  - 2025-01-22 03:15に0.193秒(通常の約8倍)
  - 2025-01-22 09:15に0.103秒(通常の約4倍)
    
2. Aurora DMLレイテンシーの上昇傾向
  - 2025-01-23 11:00-12:00の間で4.0-5.0ms台に上昇(通常の約1.5倍)
  - 2025-01-23 06:00-07:00の間で5.0-6.3ms台まで上昇(通常の約2倍)
  
## リクエスト数とレスポンスタイムの相関
1. 定常的なリクエストパターン
  - 1時間ごとに4リクエストの定期的なパターンを確認
  - 一部時間帯で6-15リクエストの突発的な増加を観測  
  - 2025-01-23 13:55: 6リクエスト  
  - 2025-01-22 03:15: 15リクエスト  
  - 2025-01-22 09:15: 8リクエスト
  
2. レスポンスタイムへの影響
  - リクエスト数増加時にALBターゲットレスポンスタイムが悪化
  - Aurora DMLレイテンシーも同期して上昇傾向
  
## 推奨アクション
1. ALBターゲットの負荷分散設定の見直し
2. リクエスト集中時のAuroraのキャパシティ確保
3. 定期的なリクエストのスケジューリング分散化の検討
```

出力形式の指定、観点を増やしかつ詳細化、入力メトリクスの精査などまだまだ改善できるところはありそうです。
推奨される対応は出力しなくても良さそうです。  

## 今後の展開

ALB と Aurora のメトリクスを組み合わせただけで PoC を開始しました。様々なメトリクスの組み合わせを試してみたいと考えています。
ログをメトリクス化してこの仕組みで使用するのも面白そうです。  
ChatBot のように連続して会話しながらダッシュボードチェックができると記事の冒頭であげたような心配が解決できそうです。  

[CloudWatch anomaly detection](https://aws.amazon.com/jp/blogs/news/new-amazon-cloudwatch-anomaly-detection/) や [Amazon Q Developer による運用上の問題の調査と修正](https://aws.amazon.com/jp/blogs/news/investigate-and-remediate-operational-issues-with-amazon-q-developer/) なども取り込むとより問題の早期発見ができそうです。

ここで使っている Lambda 関数のソースコードもいずれは公開したいと考えています。

## 宣伝

私が運営に関わっている OpsJAWS では、AIOps に関する勉強会を開催します。  
会場とオンラインのハイブリット開催です。上の話も含めて多くの AIOps に関する話を聞けると思います。お気軽に参加ください。

https://opsjaws.connpass.com/event/342300/
