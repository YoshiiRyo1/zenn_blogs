---
title: "AWS Distro for OpenTelemetry ã§ APM ã«è¿‘ä»˜ã"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","ADOT","OpenTelemetry"]
published: false
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

å‰å›ã¯ AWS Distro for OpenTelemetry ã‚’ã‚¼ãƒ­ã‹ã‚‰å­¦ã¶ã¨ã„ã†ã“ã¨ã§ã€CloudWatch Agent ã‚’çµŒç”±ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¦ã¿ã¾ã—ãŸã€‚  

@[card](https://zenn.dev/ryoyoshii/articles/27cd6ba802979e)  


ä»Šå›ã¯ã‚‚ã†å°‘ã—é€²ã‚“ã§ ADOT Collector ã‚’è¨ˆè£…ã—ã¦ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åŸºæœ¬3ç¨®ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚  
ã–ã£ãã‚Šã—ãŸæ§‹æˆã¯ä»¥ä¸‹ã§ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å‰å›ã¨åŒã˜ã [ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³](https://opentelemetry.io/docs/instrumentation/java/getting-started/) ã‚’ä½¿ã„ã¾ã™ã€‚
ECS on Fargate ä¸Šã§å‹•ã‹ã—ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã« ADOT Collector ã‚’èµ°ã‚‰ã›ã¾ã™ã€‚Collector ã§åé›†ã—ãŸãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã¯ CloudWatch ã¸ä¿ç®¡ã—ã¾ã™ã€‚  

![img](/images/adot_collector_ecs.drawio.png)


ãã‚Œã§ã¯ã‚„ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚  

## ECS ç”¨ IAM ãƒ­ãƒ¼ãƒ«ä½œæˆ

ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  

### ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

ä½œæˆæ‰‹é †ã¯ [ã‚¿ã‚¹ã‚¯ IAM ãƒ­ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task-iam-roles.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries",
                "cloudwatch:PutMetricData",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "logs:CreateLogStream",
                "logs:CreateLogGroup"
            ],
            "Resource": [
                "*"
            ]
        }
    ]
}
```
::::

### ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«

ä½œæˆæ‰‹é †ã¯ [Amazon ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ IAM ãƒ­ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_execution_IAM_role.html) ã‚’å‚ç…§ãã ã•ã„ã€‚    
ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ã¯ `AmazonECSTaskExecutionRolePolicy` ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚  

## ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ã‚­ãƒ¼ (CMK) ä½œæˆ

ADOT Collector ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ Collector ã®è¨­å®šå¤‰æ›´ã®ãŸã³ã« Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚Šç›´ã™æ‰‹é–“ã‚’çœããŸã‚ã§ã™ã€‚
ã‹ã¤ã€SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¯æš—å·åŒ–ã—ã¦äºˆæœŸã›ã¬å¤‰æ›´ã‚’é˜²æ­¢ã—ã¾ã™ã€‚  

CMK ã®ä½œæˆæ‰‹é †ã¯ [ã‚­ãƒ¼ã®ä½œæˆ](https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/create-keys.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚­ãƒ¼ãƒãƒªã‚·ãƒ¼ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«å®Ÿéš›ã® ID ã‚„ ARN ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚ã¾ãŸã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ CMK ã‚’ä½œã‚‹ã¨ã‚­ãƒ¼ãƒãƒªã‚·ãƒ¼ãŒæ¯”è¼ƒçš„ç°¡å˜ã«ä½œæˆå¯èƒ½ã§ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Id": "key-consolepolicy-3",
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:root"
            },
            "Action": "kms:*",
            "Resource": "*"
        },
        {
            "Sid": "Allow access for Key Administrators",
            "Effect": "Allow",
            "Principal": {
                "AWS": "ã‚­ãƒ¼ç®¡ç†è€…ã®IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ­ãƒ¼ãƒ« ARN"
            },
            "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:TagResource",
                "kms:UntagResource",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow use of the key",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow attachment of persistent resources",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:CreateGrant",
                "kms:ListGrants",
                "kms:RevokeGrant"
            ],
            "Resource": "*",
            "Condition": {
                "Bool": {
                    "kms:GrantIsForAWSResource": "true"
                }
            }
        }
    ]
}
```
::::

## SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

ADOT Collector è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’ä½œæˆã—ã¾ã™ã€‚  
æ‰‹é †ã¯ [Parameter Store ã®ä½¿ç”¨](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/parameter-store-working-with.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚¿ã‚¤ãƒ—ã¯`å®‰å…¨ãªæ–‡å­—åˆ—`ã‚’é¸æŠè‚¢ã€`KMS ã‚­ãƒ¼ ID`ã¯å‰ã®æ‰‹é †ã§ä½œã£ãŸã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¾ã™ã€‚  
å€¤ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«å®Ÿéš›ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚„è¨­å®šå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
receivers:
  otlp:
    protocols:
      grpc:
      http:

processors:
  batch:

  memory_limiter:
    limit_mib: 100
    check_interval: 5s


exporters:
  awsxray:
    region: us-west-2

  awsemf:
    region: 'us-west-2'
    dimension_rollup_option: "NoDimensionRollup"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsemf]
```
::::


## ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 

ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«æˆ»ã‚Šã¾ã—ã¦ã€KMS ã¨ SSM ã¸ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚  
å‰ã®æ‰‹é †ã§ä½œæˆã—ãŸ ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã‹ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ä½œã‚Šã€ä»¥ä¸‹ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameters",
                "kms:Decrypt"
            ],
            "Resource": [
                "SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã® ARN",
                "KMS CMK ã® ARN"
            ]
        }
    ]
}
```
::::

## Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ ECS ã§å‹•ã‹ã™ãŸã‚ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚  

### ãƒ•ã‚¡ã‚¤ãƒ«ç”¨æ„

ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  

```
.
â”œâ”€ Dockerfile
â”œâ”€ DiceApplication.java   # https://opentelemetry.io/docs/instrumentation/java/getting-started/
â”œâ”€ RollController.java    # https://opentelemetry.io/docs/instrumentation/java/getting-started/
â”œâ”€ build.gradle.kts
â””â”€ logback.xml
```

#### Dockerfile

ä»¥ä¸‹ã‚’å‚è€ƒã«å¾®ä¿®æ­£ã—ã¦ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã™ã€‚  
JAVA_TOOL_OPTIONS ã§è‡ªå‹•è¨ˆè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ãƒ­ã‚°å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã‚’ã—ã¦ã„ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```dockerfile:Dockerfile
FROM public.ecr.aws/docker/library/gradle:jdk17 AS builder

WORKDIR /java-simple
COPY *.java .
COPY build.gradle.kts .

RUN ["gradle", "assemble"]

FROM gcr.io/distroless/java17-debian11:latest

WORKDIR /java-simple
COPY --from=builder /java-simple/build/libs/ ./build/libs/
COPY logback.xml ./logback.xml

ADD https://github.com/aws-observability/aws-otel-java-instrumentation/releases/download/v1.31.0/aws-opentelemetry-agent.jar ./aws-opentelemetry-agent.jar
ENV JAVA_TOOL_OPTIONS "-javaagent:/java-simple/aws-opentelemetry-agent.jar -Dlogging.config=/java-simple/logback.xml"

ENV OTEL_RESOURCE_ATTRIBUTES "service.name=dice-server"
ENV OTEL_IMR_EXPORT_INTERVAL "60000"
ENV OTEL_EXPORTER_OTLP_ENDPOINT "http://127.0.0.1:4317"

CMD ["/java-simple/build/libs/java-simple.jar"]
```
::::

#### build.gradle.kts

dependencies ã§è‡ªå‹•è¨ˆè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ Logback ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚  

è‡ªå‹•è¨ˆè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ [releases](https://github.com/aws-observability/aws-otel-java-instrumentation/releases) ã‚’èª¿ã¹ã¦ãã ã•ã„ã€‚  
Logback ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ [latest release](https://search.maven.org/search?q=g:io.opentelemetry.instrumentation%20AND%20a:opentelemetry-logback-mdc-1.0) ã‚’èª¿ã¹ã¦ãã ã•ã„ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```gradle:build.gradle.kts
plugins {
  id("java")
  id("org.springframework.boot") version "3.0.6"
  id("io.spring.dependency-management") version "1.1.0"
}

sourceSets {
  main {
    java.setSrcDirs(setOf("."))
  }
}

repositories {
  mavenCentral()
}

dependencies {
  implementation("org.springframework.boot:spring-boot-starter-web")
  implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")
  runtimeOnly("io.opentelemetry.instrumentation:opentelemetry-logback-mdc-1.0:1.31.0-alpha")
}
```
::::

#### logback.xml

ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã« AWS X-Ray å½¢å¼ã®ãƒˆãƒ¬ãƒ¼ã‚¹ ID ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ­ã‚°ã®ç´ã¥ã‘ãŒ CloudWatch ä¸Šã§å¯èƒ½ã«ãªã‚Šãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å½¹ç«‹ã¡ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```xml:logback.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} trace_id=%X{AWS-XRAY-TRACE-ID} span_id=%X{span_id} trace_flags=%X{trace_flags} %msg%n</pattern>
    </encoder>
  </appender>

  <!-- Just wrap your logging appender, for example ConsoleAppender, with OpenTelemetryAppender -->
  <appender name="OTEL" class="io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender">
    <appender-ref ref="CONSOLE"/>
  </appender>

  <!-- Use the wrapped "OTEL" appender instead of the original "CONSOLE" one -->
  <root level="DEBUG">
    <appender-ref ref="OTEL"/>
  </root>

</configuration>
```
::::


### ãƒ“ãƒ«ãƒ‰

Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œã£ã¦ãŠãã¾ã™ã€‚
ç‰¹ã«æ±ºã¾ã£ãŸå ´æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€AWS ã«ã¯ ECR ãŒã‚ã‚Šã¾ã™ã®ã§ä»Šå›ã¯ ECR ã‚’ä½¿ã„ã¾ã™ã€‚  
ãƒªãƒã‚¸ãƒˆãƒªã®ä½œã‚Šæ–¹ã¯ [Amazon ECR ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª](https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/Repositories.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  

ãƒ“ãƒ«ãƒ‰ã—ã¦ ECR ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚  

```bash
docker build . -t your_aws_account_id.dkr.ecr.us-west-2.amazonaws.com/imagename:tagname
docker push your_aws_account_id.dkr.ecr.us-west-2.amazonaws.com/imagename:tagname
```

## NLB ä½œæˆ

ALB ã§ã‚‚ NLB ã§ã‚‚ã©ã¡ã‚‰ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚  
ä»Šå›ã¯æœ€è¿‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸ NLB ã‚’ä½¿ã„ã¾ã™ã€‚  
ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã¯ã€Œipã€ã‚’é¸æŠã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚ECS ã‚¿ã‚¹ã‚¯ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å«ã‚ã‚‹ãŸã‚ã§ã™ã€‚  

[Network Load Balancers](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html) ã‚’å‚ç…§ã—ã¦ NLB ã‚’ä½œæˆã—ã¾ã™ã€‚  

## ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ

Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã§ããŸã‚‰ ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚  
ä½œæˆæ‰‹é †ã¯ [AWS Fargate ã® Linux ã‚³ãƒ³ãƒ†ãƒŠã«ã‚ˆã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ä½¿ç”¨é–‹å§‹](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/getting-started-fargate.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  

Container Insights ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚  

ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã¯å‰ã®æ‰‹é †ã§ä½œæˆã—ãŸã‚‚ã®ã‚’ä½¿ã„ã¾ã™ã€‚  

ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ ADOT Collector ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¾®ä¿®æ­£ã—ã¦åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚  
`secrets` ã®é …ç›®ã¯å‰ã®æ‰‹é †ä½œæˆã—ãŸ SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢åã‚’æŒ‡å®šã—ã¾ã™ã€‚  


::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
    "containerDefinitions": [
        {
            "name": "dice",
            "image": "your_aws_account_id.dkr.ecr.us-west-2.amazonaws.com/imagename:tagname",
            "cpu": 0,
            "portMappings": [
                {
                    "name": "dice-8080-tcp",
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "protocol": "tcp",
                    "appProtocol": "http"
                }
            ],
            "essential": true,
            "environment": [],
            "mountPoints": [],
            "volumesFrom": [],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/ecs/your_apps",
                    "awslogs-region": "us-west-2",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        },
        {
            "name": "aws-otel-collector",
            "image": "public.ecr.aws/aws-observability/aws-otel-collector:v0.35.0",
            "cpu": 0,
            "portMappings": [],
            "essential": true,
            "environment": [],
            "mountPoints": [],
            "volumesFrom": [],
            "secrets": [
                {
                    "name": "AOT_CONFIG_CONTENT",
                    "valueFrom": "otel-collector-config"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/ecs/ecs-aws-otel-sidecar-collector",
                    "awslogs-region": "us-west-2",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ],
```
::::

## CloudWatch ã®è¦³ãˆæ–¹

ECS ã‚¿ã‚¹ã‚¯(ã‚³ãƒ³ãƒ†ãƒŠ) ãŒå‹•ã„ãŸã‚‰ã„ã‚ˆã„ã‚ˆ CloudWatch ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ã©ã‚Œã ã‘ã®æƒ…å ±ãŒå–ã‚Œã¦ã„ã‚‹ã®ã‹æ¥½ã—ã¿ã§ã™ã€‚
[å‰å›](https://zenn.dev/ryoyoshii/articles/27cd6ba802979e)ã¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®ã¿ã ã£ãŸã®ã§é•ã„ã‚’æœŸå¾…ã—ã¾ã™ã€‚  

å‰å›ã¨åŒã˜ã curl ã‚³ãƒãƒ³ãƒ‰ã‚’é€£æ‰“ã—ã¾ã™ã€‚  

```bash
while true 
do
  curl http://nlb-url/rolldice
  sleep 10
done
```

### ãƒˆãƒ¬ãƒ¼ã‚¹

ãƒˆãƒ¬ãƒ¼ã‚¹å–ã‚Œã¦ã„ã¾ã™ã€‚  
ãã—ã¦ã€ä»Šå›ã¯ãƒ­ã‚°ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚„ã‚Šã¾ã—ãŸã€‚  
ã‚‚ã—ç•°å¸¸ã‚„é…å»¶ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ­ã‚°ãŒç´ä»˜ã„ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã¯æœ‰ç”¨ã§ã™ã€‚ä»Šã¾ã§ã®è‹¦åŠ´ã¯ä½•ã§ã‚ã£ãŸã®ã‹ã¨æ€ã†ã»ã©ã§ã™ã€‚    

![img](/images/xray_trace_with_log.png)


CloudWatch Logs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ­ã‚°ã«ã¯ X-Ray ãƒˆãƒ¬ãƒ¼ã‚¹ ID (trace_id) ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚CloudWatch Logs Insights ã§ã“ã‚Œã‚’æ¤œç´¢ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ç”»é¢ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚  

```
00:50:13.242 trace_id=1-655415c5-f8ce3ffe767daf7d6ef94d72@ed4719643c9748b6 span_id=ed4719643c9748b6 trace_flags=01 GET "/rolldice", parameters={}
```

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚  
CloudWatch ç”»é¢ã§ `dice-server` ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ åå‰ç©ºé–“ãŒå¢—ãˆã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«æŒ‡å®šã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•° `ENV OTEL_RESOURCE_ATTRIBUTES "service.name=dice-server"` ã§ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼åç§°ã§ã™ã€‚  
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚è¿½åŠ ã§å–å¾—ã§ãã¦ã„ã¾ã™ã€‚  

![img](/images/adot-metrices.png)

![img](/images/adot-metrices-dice.png)

<br />
ã“ã“ã§å–å¾—ã—ãŸã„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã¯ Java ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã®ã§ä¸»ã« JVM ã®æƒ…å ±ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
è‡ªå‹•è¨ˆè£…ã§ã©ã®ã‚ˆã†ãªæƒ…å ±ãŒå–å¾—ã§ãã‚‹ã‹ã¯ä»¥ä¸‹ã‚’å‚ç…§ãã ã•ã„ã€‚    
[Supported libraries, frameworks, application servers, and JVMs](https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks)  


## ã¾ã¨ã‚

ADOT Collector ã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸã€‚  
å•†ç”¨ã® Observerbility SaaS ã«æ¯”è¼ƒã™ã‚‹ã¨ç‰©è¶³ã‚Šãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€AWS å†…ã§å®Œçµã™ã‚‹ç’°å¢ƒã§ã‚‚ APM ã¯å®Ÿç¾å¯èƒ½ã§ã™ã€‚  

AWS ä¸Šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§åŸºæœ¬3ç¨®ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ã“ã®ã‚ˆã†ãªæ§‹æˆãŒåŸºæœ¬ã«ãªã‚‹ã¨è€ƒãˆã¾ã™ã€‚  

- ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  - ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    - CloudWatch
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    - ADOT Collector
- ãƒ­ã‚°
  - CloudWatch Logs ã«è»¢é€ã€ä¿ç®¡
  - X-Ray ãƒˆãƒ¬ãƒ¼ã‚¹ ID ã‚’ãƒ­ã‚°ã«åŸ‹ã‚è¾¼ã‚€
- ãƒˆãƒ¬ãƒ¼ã‚¹
  - ADOT Collector

## å‚è€ƒ


[AWS Distro for OpenTelemetry Documentation](https://aws-otel.github.io/docs/introduction)  

[AWS X-Ray SDK for Java](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java.html)  

[A language-specific implementation of OpenTelemetry in Java.](https://opentelemetry.io/docs/instrumentation/java/)  
[Logger MDC auto-instrumentation](https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/logger-mdc-instrumentation.md)  

[GitHub aws-observability](https://github.com/aws-observability)  
[AWS Observability Best Practices](https://aws-observability.github.io/observability-best-practices/)  


