---
title: "AWS Distro for OpenTelemetry ã§ APM ã«è¿‘ä»˜ã"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","ADOT","OpenTelemetry"]
published: false
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

å‰å›ã¯ AWS Distro for OpenTelemetry ã‚’ã‚¼ãƒ­ã‹ã‚‰å­¦ã¶ã¨ã„ã†ã“ã¨ã§ã€CloudWatch Agent ã‚’çµŒç”±ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¦ã¿ã¾ã—ãŸã€‚  

@[card](https://zenn.dev/ryoyoshii/articles/27cd6ba802979e)  


ä»Šå›ã¯ã‚‚ã†å°‘ã—é€²ã‚“ã§ ADOT Collector ã‚’è¨ˆè£…ã—ã¦ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åŸºæœ¬3ç¨®ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚  
ã–ã£ãã‚Šã—ãŸæ§‹æˆã¯ä»¥ä¸‹ã§ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å‰å›ã¨åŒã˜ã [ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³](https://opentelemetry.io/docs/instrumentation/java/getting-started/) ã‚’ä½¿ã„ã¾ã™ã€‚
ECS on Fargate ä¸Šã§å‹•ã‹ã—ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã« ADOT Collector ã‚’èµ°ã‚‰ã›ã¾ã™ã€‚Collector ã§åé›†ã—ãŸãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã¯ CloudWatch ã¸ä¿ç®¡ã—ã¾ã™ã€‚  

![img](/images/adot_collector_ecs.drawio.png)


ãã‚Œã§ã¯ã‚„ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚  

## ECS ç”¨ IAM ãƒ­ãƒ¼ãƒ«ä½œæˆ

ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  

### ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

ä½œæˆæ‰‹é †ã¯ [ã‚¿ã‚¹ã‚¯ IAM ãƒ­ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task-iam-roles.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries",
                "cloudwatch:PutMetricData",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "logs:CreateLogStream",
                "logs:CreateLogGroup"
            ],
            "Resource": [
                "*"
            ]
        }
    ]
}
```
::::

### ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«

ä½œæˆæ‰‹é †ã¯ [Amazon ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ IAM ãƒ­ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_execution_IAM_role.html) ã‚’å‚ç…§ãã ã•ã„ã€‚    
ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ã¯ `AmazonECSTaskExecutionRolePolicy` ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚  

## ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ã‚­ãƒ¼ (CMK) ä½œæˆ

ADOT Collector ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ Collector ã®è¨­å®šå¤‰æ›´ã®ãŸã³ã« Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚Šç›´ã™æ‰‹é–“ã‚’çœããŸã‚ã§ã™ã€‚
ã‹ã¤ã€SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¯æš—å·åŒ–ã—ã¦äºˆæœŸã›ã¬å¤‰æ›´ã‚’é˜²æ­¢ã—ã¾ã™ã€‚  

CMK ã®ä½œæˆæ‰‹é †ã¯ [ã‚­ãƒ¼ã®ä½œæˆ](https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/create-keys.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚­ãƒ¼ãƒãƒªã‚·ãƒ¼ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«å®Ÿéš›ã® ID ã‚„ ARN ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚ã¾ãŸã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ CMK ã‚’ä½œã‚‹ã¨ã‚­ãƒ¼ãƒãƒªã‚·ãƒ¼ãŒæ¯”è¼ƒçš„ç°¡å˜ã«ä½œæˆå¯èƒ½ã§ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Id": "key-consolepolicy-3",
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:root"
            },
            "Action": "kms:*",
            "Resource": "*"
        },
        {
            "Sid": "Allow access for Key Administrators",
            "Effect": "Allow",
            "Principal": {
                "AWS": "ã‚­ãƒ¼ç®¡ç†è€…ã®IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ­ãƒ¼ãƒ« ARN"
            },
            "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:TagResource",
                "kms:UntagResource",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow use of the key",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow attachment of persistent resources",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:CreateGrant",
                "kms:ListGrants",
                "kms:RevokeGrant"
            ],
            "Resource": "*",
            "Condition": {
                "Bool": {
                    "kms:GrantIsForAWSResource": "true"
                }
            }
        }
    ]
}
```
::::

## SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

ADOT Collector è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’ä½œæˆã—ã¾ã™ã€‚  
æ‰‹é †ã¯ [Parameter Store ã®ä½¿ç”¨](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/parameter-store-working-with.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  
ã‚¿ã‚¤ãƒ—ã¯`å®‰å…¨ãªæ–‡å­—åˆ—`ã‚’é¸æŠè‚¢ã€`KMS ã‚­ãƒ¼ ID`ã¯å‰ã®æ‰‹é †ã§ä½œã£ãŸã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¾ã™ã€‚  
å€¤ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«å®Ÿéš›ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚„è¨­å®šå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
receivers:
  otlp:
    protocols:
      grpc:
      http:

processors:
  batch:

  memory_limiter:
    limit_mib: 100
    check_interval: 5s


exporters:
  awsxray:
    region: us-west-2

  awsemf:
    region: 'us-west-2'
    dimension_rollup_option: "NoDimensionRollup"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsemf]
```
::::


## ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 

ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«æˆ»ã‚Šã¾ã—ã¦ã€KMS ã¨ SSM ã¸ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚  
å‰ã®æ‰‹é †ã§ä½œæˆã—ãŸ ECS ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã‹ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ä½œã‚Šã€ä»¥ä¸‹ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameters",
                "kms:Decrypt"
            ],
            "Resource": [
                "SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã® ARN",
                "KMS CMK ã® ARN"
            ]
        }
    ]
}
```
::::

## Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ ECS ã§å‹•ã‹ã™ãŸã‚ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚  

### ãƒ•ã‚¡ã‚¤ãƒ«ç”¨æ„

ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  

```
.
â”œâ”€ Dockerfile
â”œâ”€ DiceApplication.java   # https://opentelemetry.io/docs/instrumentation/java/getting-started/
â”œâ”€ RollController.java    # https://opentelemetry.io/docs/instrumentation/java/getting-started/
â”œâ”€ build.gradle.kts
â””â”€ logback.xml
```

**Dockerfile**

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```dockerfile:Dockerfile
FROM public.ecr.aws/docker/library/gradle:jdk17 AS builder

WORKDIR /java-simple
COPY *.java .
COPY build.gradle.kts .

RUN ["gradle", "assemble"]

FROM gcr.io/distroless/java17-debian11:latest

WORKDIR /java-simple
COPY --from=builder /java-simple/build/libs/ ./build/libs/
COPY logback.xml ./logback.xml

ADD https://github.com/aws-observability/aws-otel-java-instrumentation/releases/download/v1.31.0/aws-opentelemetry-agent.jar ./aws-opentelemetry-agent.jar
ENV JAVA_TOOL_OPTIONS "-javaagent:/java-simple/aws-opentelemetry-agent.jar -Dlogging.config=/java-simple/logback.xml"

ENV OTEL_RESOURCE_ATTRIBUTES "service.name=dice-server,aws.log.group.names=oteldice"
ENV OTEL_IMR_EXPORT_INTERVAL "60000"
ENV OTEL_EXPORTER_OTLP_ENDPOINT "http://127.0.0.1:4317"

CMD ["/java-simple/build/libs/java-simple.jar"]
```
::::

**build.gradle.kts**

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```gradle:build.gradle.kts
plugins {
  id("java")
  id("org.springframework.boot") version "3.0.6"
  id("io.spring.dependency-management") version "1.1.0"
}

sourceSets {
  main {
    java.setSrcDirs(setOf("."))
  }
}

repositories {
  mavenCentral()
}

dependencies {
  implementation("org.springframework.boot:spring-boot-starter-web")
  implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")
  runtimeOnly("io.opentelemetry.instrumentation:opentelemetry-logback-mdc-1.0:1.31.0-alpha")
}
```
::::

**logback.xml**

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```xml:logback.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} trace_id=%X{AWS-XRAY-TRACE-ID} span_id=%X{span_id} trace_flags=%X{trace_flags} %msg%n</pattern>
    </encoder>
  </appender>

  <!-- Just wrap your logging appender, for example ConsoleAppender, with OpenTelemetryAppender -->
  <appender name="OTEL" class="io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender">
    <appender-ref ref="CONSOLE"/>
  </appender>

  <!-- Use the wrapped "OTEL" appender instead of the original "CONSOLE" one -->
  <root level="DEBUG">
    <appender-ref ref="OTEL"/>
  </root>

</configuration>
```
::::


### ãƒ“ãƒ«ãƒ‰




## å‚è€ƒ


[AWS Distro for OpenTelemetry Documentation](https://aws-otel.github.io/docs/introduction)  

[AWS X-Ray SDK for Java](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java.html)  

[A language-specific implementation of OpenTelemetry in Java.](https://opentelemetry.io/docs/instrumentation/java/)  
[Supported libraries, frameworks, application servers, and JVMs](https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks)  

[GitHub aws-observability](https://github.com/aws-observability)  
[AWS Observability Best Practices](https://aws-observability.github.io/observability-best-practices/)  


