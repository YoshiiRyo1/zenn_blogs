---
title: "AWS Distro for OpenTelemetry で APM に近付く"
emoji: "🔖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS","ADOT","OpenTelemetry"]
published: false
---
こんにちは。  
ご機嫌いかがでしょうか。  
"No human labor is no human error" が大好きな[吉井 亮](https://twitter.com/YoshiiRyo1)です。  

前回は AWS Distro for OpenTelemetry をゼロから学ぶということで、CloudWatch Agent を経由してトレースを取得してみました。  

@[card](https://zenn.dev/ryoyoshii/articles/27cd6ba802979e)  


今回はもう少し進んで ADOT Collector を計装してログ・トレース・メトリクスの基本3種を取得してみます。  
ざっくりした構成は以下です。  
アプリケーションは前回と同じく [サイコロを振るサンプルアプリケーション](https://opentelemetry.io/docs/instrumentation/java/getting-started/) を使います。
ECS on Fargate 上で動かし、サイドカーに ADOT Collector を走らせます。Collector で収集したテレメトリは CloudWatch へ保管します。  

![img](/images/adot_collector_ecs.drawio.png)


それではやっていきましょう。  

## ECS 用 IAM ロール作成

タスクロールとタスク実行ロールを作成します。  

### タスクロール

作成手順は [タスク IAM ロール](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task-iam-roles.html) を参照ください。  
タスクロールには以下のポリシーを追加します。  

::::details クリックして展開
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:GetSamplingStatisticSummaries",
                "cloudwatch:PutMetricData",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "logs:DescribeLogGroups",
                "logs:CreateLogStream",
                "logs:CreateLogGroup"
            ],
            "Resource": [
                "*"
            ]
        }
    ]
}
```
::::

### タスク実行ロール

作成手順は [Amazon ECS タスク実行 IAM ロール](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_execution_IAM_role.html) を参照ください。    
タスク実行ロールには `AmazonECSTaskExecutionRolePolicy` マネージドポリシーを追加します。  

## カスタマー管理キー (CMK) 作成

ADOT Collector の設定ファイルを SSM パラメータストアに格納しています。これは Collector の設定変更のたびに Docker イメージを作り直す手間を省くためです。
かつ、SSM パラメータストアは暗号化して予期せぬ変更を防止します。  

CMK の作成手順は [キーの作成](https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/create-keys.html) を参照ください。  
キーポリシーは以下を参考に実際の ID や ARN に置き換えてください。また、マネジメントコンソールで CMK を作るとキーポリシーが比較的簡単に作成可能です。  

::::details クリックして展開
```json
{
    "Id": "key-consolepolicy-3",
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:root"
            },
            "Action": "kms:*",
            "Resource": "*"
        },
        {
            "Sid": "Allow access for Key Administrators",
            "Effect": "Allow",
            "Principal": {
                "AWS": "キー管理者のIAM ユーザー/ロール ARN"
            },
            "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:TagResource",
                "kms:UntagResource",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow use of the key",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow attachment of persistent resources",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::your_aws_account_id:role/your_ecsTaskExecutionRole"
            },
            "Action": [
                "kms:CreateGrant",
                "kms:ListGrants",
                "kms:RevokeGrant"
            ],
            "Resource": "*",
            "Condition": {
                "Bool": {
                    "kms:GrantIsForAWSResource": "true"
                }
            }
        }
    ]
}
```
::::

## SSM パラメータストア

ADOT Collector 設定ファイルを格納するパラメータストアを作成します。  
手順は [Parameter Store の使用](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/parameter-store-working-with.html) を参照ください。  
タイプは`安全な文字列`を選択肢、`KMS キー ID`は前の手順で作ったキーを指定します。  
値は以下を参考に実際のリージョンや設定値に置き換えてください。  

::::details クリックして展開
```yaml
receivers:
  otlp:
    protocols:
      grpc:
      http:

processors:
  batch:

  memory_limiter:
    limit_mib: 100
    check_interval: 5s


exporters:
  awsxray:
    region: us-west-2

  awsemf:
    region: 'us-west-2'
    dimension_rollup_option: "NoDimensionRollup"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsxray]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter,batch]
      exporters: [awsemf]
```
::::


## ECS タスク実行ロールにポリシーを追加

ECS タスク実行ロールに戻りまして、KMS と SSM への権限を付与します。  
前の手順で作成した ECS タスク実行ロールのインラインポリシーかカスタマー管理ポリシーを作り、以下の権限を付与します。  

::::details クリックして展開
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameters",
                "kms:Decrypt"
            ],
            "Resource": [
                "SSM パラメータストアの ARN",
                "KMS CMK の ARN"
            ]
        }
    ]
}
```
::::

## Docker イメージ作成

サンプルアプリケーションを ECS で動かすための Docker イメージを作成します。  

### ファイル用意

任意のディレクトリを作り以下のファイルを作成します。  

```
.
├─ Dockerfile
├─ DiceApplication.java   # https://opentelemetry.io/docs/instrumentation/java/getting-started/
├─ RollController.java    # https://opentelemetry.io/docs/instrumentation/java/getting-started/
├─ build.gradle.kts
└─ logback.xml
```

**Dockerfile**

::::details クリックして展開
```dockerfile:Dockerfile
FROM public.ecr.aws/docker/library/gradle:jdk17 AS builder

WORKDIR /java-simple
COPY *.java .
COPY build.gradle.kts .

RUN ["gradle", "assemble"]

FROM gcr.io/distroless/java17-debian11:latest

WORKDIR /java-simple
COPY --from=builder /java-simple/build/libs/ ./build/libs/
COPY logback.xml ./logback.xml

ADD https://github.com/aws-observability/aws-otel-java-instrumentation/releases/download/v1.31.0/aws-opentelemetry-agent.jar ./aws-opentelemetry-agent.jar
ENV JAVA_TOOL_OPTIONS "-javaagent:/java-simple/aws-opentelemetry-agent.jar -Dlogging.config=/java-simple/logback.xml"

ENV OTEL_RESOURCE_ATTRIBUTES "service.name=dice-server,aws.log.group.names=oteldice"
ENV OTEL_IMR_EXPORT_INTERVAL "60000"
ENV OTEL_EXPORTER_OTLP_ENDPOINT "http://127.0.0.1:4317"

CMD ["/java-simple/build/libs/java-simple.jar"]
```
::::

**build.gradle.kts**

::::details クリックして展開
```gradle:build.gradle.kts
plugins {
  id("java")
  id("org.springframework.boot") version "3.0.6"
  id("io.spring.dependency-management") version "1.1.0"
}

sourceSets {
  main {
    java.setSrcDirs(setOf("."))
  }
}

repositories {
  mavenCentral()
}

dependencies {
  implementation("org.springframework.boot:spring-boot-starter-web")
  implementation("software.amazon.opentelemetry:aws-opentelemetry-agent:1.31.0")
  runtimeOnly("io.opentelemetry.instrumentation:opentelemetry-logback-mdc-1.0:1.31.0-alpha")
}
```
::::

**logback.xml**

::::details クリックして展開
```xml:logback.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} trace_id=%X{AWS-XRAY-TRACE-ID} span_id=%X{span_id} trace_flags=%X{trace_flags} %msg%n</pattern>
    </encoder>
  </appender>

  <!-- Just wrap your logging appender, for example ConsoleAppender, with OpenTelemetryAppender -->
  <appender name="OTEL" class="io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender">
    <appender-ref ref="CONSOLE"/>
  </appender>

  <!-- Use the wrapped "OTEL" appender instead of the original "CONSOLE" one -->
  <root level="DEBUG">
    <appender-ref ref="OTEL"/>
  </root>

</configuration>
```
::::


### ビルド




## 参考


[AWS Distro for OpenTelemetry Documentation](https://aws-otel.github.io/docs/introduction)  

[AWS X-Ray SDK for Java](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java.html)  

[A language-specific implementation of OpenTelemetry in Java.](https://opentelemetry.io/docs/instrumentation/java/)  
[Supported libraries, frameworks, application servers, and JVMs](https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks)  

[GitHub aws-observability](https://github.com/aws-observability)  
[AWS Observability Best Practices](https://aws-observability.github.io/observability-best-practices/)  


