---
title: "DMARCãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æãƒ»å¯è¦–åŒ–ã™ã‚‹ parsedmarc ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["DMARC", "parsedmarc", "Elasticsearch", "Grafana"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

DMARC å¯¾å¿œã—ã¦ã„ã¾ã™ã‹ï¼Ÿ  
ãƒ¡ãƒ¼ãƒ«ç®¡ç†è€…ã®æ–¹ã€…ã®è‹¦åŠ´ãŒç›®ã«æµ®ã‹ã¶ã¾ã™ã€‚DAMRC ãƒ¬ãƒãƒ¼ãƒˆã‚’å—ã‘å–ã£ã¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã„ã£ãŸä½œæ¥­ãŒã—ã°ã‚‰ãç¶šãã“ã¨ã¨æƒ³åƒã—ã¾ã™ã€‚  

ãŸã ã€xml ã‚’è§£æã™ã‚‹ã®ã¯ç”Ÿç”£æ€§ãŒä½ã„ä½œæ¥­ã ã¨æ€ã„ã¾ã™ã€‚å°‘ã—ã§ã‚‚æ¥½ã‚’ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚  

## parsedmarc

ä»Šå›ã¯ [parsedmarc](https://domainaware.github.io/parsedmarc/) ã‚’ä½¿ã„ã¾ã™ã€‚  
parsedmarc ã¯ OSS ã® DMARC ãƒ¬ãƒãƒ¼ãƒˆè§£æã¨å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  
xml å½¢å¼ã®äººé–“ã«ã¯èª­ã¿ã«ãã„ DMARC ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿ã‚„ã™ãå¯è¦–åŒ–ã—ã¦ãã‚Œã¾ã™ã€‚  
ç§ã¯è©¦ã—ã¦ã„ãªã„ã§ã™ãŒã€IMAP ç­‰ã§ãƒ¡ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€è‡ªå‹•ã§è§£æã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚  

parsedmarc ã¯ Grafana ã¨ Elasticsearch ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚  

## ã‚„ã£ã¦ã¿ãŸ

ãƒ­ãƒ¼ã‚«ãƒ«ã§ parsedmarc ã‚’èµ·å‹•ã—ã¾ã™ã€‚  
[dmarc-visualizer](https://github.com/debricked/dmarc-visualizer) ã§ docker-compose.yml ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã‚Œã‚’åŸºã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°åŒ–ã—ã¦ã¿ã¾ã—ãŸã€‚    

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆæ§‹é€ 

```
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ big_screenshot.png
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ grafana
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ grafana-provisioning
â”‚       â”œâ”€â”€ dashboards
â”‚       â”‚   â””â”€â”€ all.yml
â”‚       â””â”€â”€ datasources
â”‚           â””â”€â”€ all.yml
â””â”€â”€ parsedmarc
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ parsedmarc.ini
```

### docker-compose.yml

Elasticsearch ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æœ€æ–°åŒ–ã¨ã€å¤‰æ•° `xpack.security.enabled=false` ã‚’è¶³ã—ã¦ã„ã¾ã™ã€‚  

```xml:docker-compose.yml
version: '3.5'
services:
  parsedmarc:
    build: ./parsedmarc/
    volumes:
      - ./files:/input:ro
      - ./output_files:/output
    command: parsedmarc -c /parsedmarc.ini /input/* --debug
    depends_on:
      - elasticsearch
    restart: on-failure

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - ./elastic_data:/usr/share/elasticsearch/data

  grafana:
    build: ./grafana/
    ports:
      - 3000:3000
    user: root
    environment:
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel
      GF_AUTH_ANONYMOUS_ENABLED: 'true'
```

### grafana/grafana-provisioning/datasources/all.yml

Elasticsearch ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ `docker-compose.yml` ã¨åˆã‚ã›ã¦ã„ã¾ã™ã€‚  

```yml:grafana/grafana-provisioning/datasources/all.yml
apiVersion: 1

datasources:
- name: 'dmarc-ag'
  type: 'elasticsearch'
  access: 'proxy'
  orgId: 1
  url: 'http://elasticsearch:9200'
  database: '[dmarc_aggregate-]YYYY-MM-DD'
  isDefault: true
  jsonData:
    esVersion: 8.12.0
    timeField: 'date_range'
    interval: 'Daily'
  version: 1
  editable: false
- name: 'dmarc-fo'
  type: 'elasticsearch'
  access: 'proxy'
  orgId: 1
  url: 'http://elasticsearch:9200'
  database: '[dmarc_forensic-]YYYY-MM-DD'
  isDefault: false
  jsonData:
    esVersion: 8.12.0
    timeField: 'arrival_date'
    interval: 'Daily'
  version: 1
  editable: false
```

### parsedmarc/Dockerfile

python ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°åŒ–ã—ã¦ã„ã¾ã™ã€‚  
```msgraph-core==0.2.2``` ã—ãªã„ã¨å‹•ã‹ãªã‹ã£ãŸã®ã§ãã†ã—ã¦ã„ã¾ã™ã€‚[IMAP doesn't work any more #54](https://github.com/debricked/dmarc-visualizer/issues/54)  

```dockerfile:parsedmarc/Dockerfile
FROM python:3.9.18-alpine3.19

RUN apk add --update --no-cache libxml2-dev libxslt-dev build-base libffi-dev \
    && pip install parsedmarc msgraph-core==0.2.2

COPY parsedmarc.ini /
```

### grafana/Dockerfile

grafana ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ latest ã§æŒ‡å®šã—ã¾ã—ãŸã€‚(ã‚„ã‚‰ãªãã¦ã‚‚ã„ã„ã‘ã©)  

```dockerfile:grafana/Dockerfile
FROM grafana/grafana:latest

ADD --chown=grafana:root https://raw.githubusercontent.com/domainaware/parsedmarc/master/grafana/Grafana-DMARC_Reports.json /var/lib/grafana/dashboards/
RUN chmod 644 /etc/grafana/provisioning

COPY grafana-provisioning/ /etc/grafana/provisioning/
```

### èµ·å‹•

up ã§èµ·å‹•ã—ã¾ã—ã‚‡ã†ã€‚  

```bash
$ docker-compose up -d
```

èµ·å‹•ã™ã‚‹ã¨ `files` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ã“ã“ã« DMARC ãƒ¬ãƒãƒ¼ãƒˆã‚’é…ç½®ã—ã¾ã™ã€‚  

## å¯è¦–åŒ–

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚  
Grafana ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Home â†’ Dashboards â†’ DMARC Reports ã®é †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  

è¦‹ãˆã¾ã—ãŸã€‚ç§ãŒæŒã£ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã¯ DKIM ã§ä½•ä»¶ã‹ false ã«ãªã£ã¦ã„ã¾ã™ã€‚  

![Alt text](/images/parsedmarc_summary.png)  

ãƒ™ã‚¢ãƒ¡ãƒ¼ãƒ«ã•ã‚“ã®ã‚µã‚¤ãƒˆãŒã¨ã¦ã‚‚ç†è§£ã—ã‚„ã™ã‹ã£ãŸã®ã§ã“ã¡ã‚‰ã‚’å‚ç…§ã«ã—ãªãŒã‚‰ã€Grafana ã‚’ç¢ºèªã—ã¾ã™ã€‚  
@[card](https://baremail.jp/blog/2023/09/26/3474/)  

### Overview

ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ƒã”ã¨ã« SPFã€DKIM ã®èªè¨¼çµæœã‚’å¯è¦–åŒ–ã—ã¦ãã‚Œã¾ã™ã€‚  

Grafana ã® Overview ã«æ³¨ç›®ã—ã¾ã™ã€‚  
![Alt text](/images/parsedmarc_overview.png)


SFPã€DKIMã€SPF Auth Resultã€DKIM Auth Resultã€ã“ã®4é …ç›®ã¨ DMARC èªè¨¼ã®é–¢ä¿‚ã¯ä¸Šã®ãƒ™ã‚¢ãƒ¡ãƒ¼ãƒ«ã•ã‚“ã®ã‚µã‚¤ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚pass ã—ã¦ã„ãªã„ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¯å¯¾ç­–ã‚’è¡Œã„ã¾ã™ã€‚  

![img](https://baremail.jp/blog/wp-content/uploads/2023/09/DMARC_alignment.png)
*https://baremail.jp/blog/wp-content/uploads/2023/09/DMARC_alignment.png ã‚ˆã‚Šå¼•ç”¨*


### Published Policies (as reported)

Published Policies ã«æ³¨ç›®ã—ã¾ã™ã€‚  

DKIM Policy ã¯ DKIM ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã€SPF Policy ã¯ SPF ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚
relaxed mode ã¾ãŸã¯ strict mode ãŒã‚ã‚Šã€relaxed mode ã¯ DKIM ã¾ãŸã¯ SPF ã§èªè¨¼ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ From ãƒ˜ãƒƒãƒ€ã®çµ„ç¹”ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä¸€è‡´ã—ã¦ã‚Œã°ã‚ˆãã€strict mode ã¯ã‚ˆã‚Šå³å¯†ã§å®Œå…¨ä¸€è‡´(ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¾ã§)ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã©ã¡ã‚‰ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã‹ã¯ç¢ºèªã—ã¦ãŠã„ãŸã»ã†ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚    

Policy ã¯ DMARC ãƒãƒªã‚·ãƒ¼ã§ã™ã€‚å—ä¿¡è€…ã«å¯¾ã—èªè¨¼ãŒå¤±æ•—ã—ãŸéš›ã®å‹•ä½œã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚  
none ã¯ä½•ã‚‚ã—ãªã„ã¨ã„ã†æ„å‘³ã§ã™ã€‚quarantine ã¯ä¸å¯©ãƒ¡ãƒ¼ãƒ«ã€reject ã¯æ‹’å¦ã§ã™ã€‚none ã§ã‚ã‚Œã°ã¨ã‚Šãˆã‚ãšé€ä¿¡ã¯ã§ãã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç›¸æ‰‹ã®è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã«å…¥ã‚‹ã‹ã©ã†ã‹ã¯ä¸æ˜ã§ã™ãŒã€‚ã€‚  

![Alt text](/images/parsedmarc_publishedpolicies.png)  

ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚è©³ã—ãã¯ã“ã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„ã€‚  
@[card](https://www.naritai.jp/guidance_record.html)

### SPF Alignment Details

SPF ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã«åˆæ ¼ã™ã‚‹ã«ã¯ã€`Envelope From` ã¨ `Header From` ãŒä¸€è‡´ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã‚’è¦‹ã‚‹ã¨ä¸€è‡´ã—ã¦ã„ãªã„ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ãŒåˆ¤æ˜ã—ã¾ã™ã€‚  

![Alt text](/images/parsedmarc_detail.png)

### DKIM Alignment Details

DKIM ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã«åˆæ ¼ã™ã‚‹ã«ã¯ã€DKIM ç½²åã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ From ãƒ˜ãƒƒãƒ€ãŒä¸€è‡´ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚  

![Alt text](/images/parsedmarc_detail.png)


### ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

`output_files` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« csv ã¾ãŸã¯ json ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚æ‰‹å…ƒã§åŠ å·¥ã—ãŸã„å ´åˆã¯ã“ã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚  

```bash
$ ls output_files/
aggregate.csv  aggregate.json forensic.csv   forensic.json  samples
```



## ã¾ã¨ã‚

ä½•ç¨®é¡ã‹ DMARC ãƒ¬ãƒãƒ¼ãƒˆè§£æã‚’è©¦ã—ã¦ã¿ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ parsedmarc ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚  
ç¾ä»£ã«ãŠã„ã¦ã‚‚ãƒ¡ãƒ¼ãƒ«ã¯ä¸»è¦ãªé€£çµ¡æ‰‹æ®µã ã¨æ€ã„ã¾ã™ã€‚ä¿¡é ¼æ€§ã®é«˜ã„ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã« DMARC å¯¾å¿œã¯å¿…é ˆã ã¨æ€ã„ã¾ã™ã€‚  

