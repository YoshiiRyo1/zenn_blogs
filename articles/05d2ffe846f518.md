---
title: "Dify チャットフローを AI が生成する仕組みを AI で作った話"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Dify","ClaudeCode","AgentTeam"]
published: true
---
こんにちは。  
ご機嫌いかがでしょうか。  
"No human labor is no human error" が大好きな[吉井 亮](https://twitter.com/YoshiiRyo1)です。  

Dify 環境を整備しています。
Dify は AI を活用した業務フローや AI エージェントをローコードで構築できるプラットフォームです。
非開発者でも比較的容易に業務の自動化・半自動化が実現できることが魅力だと考えています。
ただ、開発知識が全く無い人がすぐに Dify チャットフローを書けるかと聞かれれば、そうではないと答えると思います。簡単だけど簡単ではないというところでしょうか。

そこで今回は Dify チャットフローを自然言語で生成する `Dify DSL Generator` を作ってみました。
ただ作るだけでは面白くないので Claude Code に作ってもらいます。

## Claude Code で計画を練る

`Dify DSL Generator` をどこのプラットフォームで作るのかを考えます。Dify 上に構築する方法と ChatGPT や Gemini を作る方法を検討します。Claude Code に検討とレポート作成を指示します。

```
あなたは Dify を活用した業務シニアコンサルタントです。
Dify チャットフローを自然言語で生成できるような仕組みを考えてください。
agent team を作り3人のコンサルタントで会話し、集約したレポートを生成してください。
1. Dify エージェント機能とナレッジ機能を推薦するコンサルタント
2. カスタムGPTs や Gem を推薦するコンサルタント
3. それ専用の Dify ツールを作ることを推薦するコンサルタント
```

上を指示して暫く待つとレポートが生成されます。
レポートは以下に貼り付けました。長いのでアコーディオンにしてます。読みたい方はトグルを開いてください。

:::details クリックして開く
```markdown
# Dify チャットフロー自然言語生成 — コンサルティングレポート

**作成日**: 2026-02-17
**チーム構成**: 3名のシニアコンサルタントによる並列分析・統合レポート

---

## エグゼクティブサマリ

本レポートは、「Dify チャットフローを自然言語で生成できる仕組み」について、3つの異なるアプローチを専門コンサルタントが独立に分析し、その結果を統合したものである。

### 結論

**段階的アプローチを推奨する**。具体的には以下の3フェーズでの導入を提案する:

| フェーズ              | アプローチ            | 期間    | 目的                         |
| --------------------- | --------------------- | ------- | ---------------------------- |
| **Phase 1（PoC）**    | Dify Agent + ナレッジ | 3-4週間 | 最小コストで実現可能性を検証 |
| **Phase 2（拡張）**   | Custom GPTs 併用      | 2-3週間 | UX向上・API直接連携の実現    |
| **Phase 3（本格化）** | 専用Difyツール開発    | 12-17日 | 品質保証・完全統合の実現     |

Phase 1 で得られたナレッジ・プロンプト知見を Phase 3 に引き継ぐことで、投資を無駄にしない段階的発展が可能である。

---

## 1. 背景と目的

### 1.1 現在のプロジェクト状況

本プロジェクトは Dify カスタムプラグインを開発・管理するリポジトリであり、以下の資産が稼働中である:

| プラグイン | バージョン | 概要                                             |
| ---------- | ---------- | ------------------------------------------------ |
| Slack Bot  | v0.0.12    | Slack @メンション → Dify Chatflow → スレッド返信 |
| Jira       | v0.0.7     | Jira Cloud API 連携（21種のツール）              |

### 1.2 解決すべき課題

現在、Dify チャットフローの構築には Dify ビジュアルエディタでの手動操作が必要であり、以下の課題がある:

- チャットフロー構築に専門知識が必要
- フロー設計の再利用・テンプレート化が困難
- 構築工数がボトルネックになっている

### 1.3 目標

自然言語で要件を記述するだけで、Dify チャットフロー DSL（YAML/JSON）が自動生成され、Dify にインポート可能な仕組みを構築する。

---

## 2. 各アプローチの詳細分析

### 2.1 アプローチA: Dify Agent + ナレッジベース（RAG）

**推薦者**: コンサルタントA

#### 概要

Dify に標準搭載されている Agent モードとナレッジベース（RAG）機能を組み合わせ、自然言語からチャットフロー DSL を生成する。

#### アーキテクチャ

```
ユーザー（自然言語で要件記述）
    ↓
Dify Agent（システムプロンプトでDSL生成を指示）
    ↓ RAG検索
ナレッジベース（DSLスキーマ / テンプレート集 / ノードカタログ）
    ↓ Few-shot補強
LLM によるDSL生成（YAML/JSON）
    ↓ 手動確認
Dify へインポート
```

#### 構築手順

| ステップ | 内容                                                                              | 期間    |
| -------- | --------------------------------------------------------------------------------- | ------- |
| Step 1   | ナレッジベース構築（DSLスキーマ、テンプレート集、ノードカタログ、プラグイン仕様） | 1-2週間 |
| Step 2   | Agent アプリ作成（システムプロンプト設計、パラメータ調整）                        | 1週間   |
| Step 3   | DSL 検証・インポートフロー整備                                                    | 1週間   |

#### ナレッジベースの構成

| カテゴリ        | 内容                                 | 用途                             |
| --------------- | ------------------------------------ | -------------------------------- |
| DSLスキーマ定義 | Dify DSLの公式仕様、ノードタイプ定義 | 構文的に正しいDSL生成の保証      |
| テンプレート集  | 実績のあるチャットフローDSL例        | Few-shotプロンプティングの参考例 |
| ノードカタログ  | 各ノードの入出力仕様、接続ルール     | ノード間接続の妥当性検証         |

#### システムプロンプト設計例

```
あなたはDifyチャットフローDSLジェネレータです。
ユーザーの自然言語による要件記述から、Dify DSL仕様に準拠した
YAML形式のチャットフロー定義を生成してください。

【生成ルール】
1. ナレッジベースから取得したDSLスキーマに厳密に従うこと
2. ノード間の接続は入出力型の互換性を検証すること
3. 利用可能なカスタムプラグイン（Slack Bot, Jira等）を適切に参照すること
4. 生成したDSLには各ノードの目的をコメントで付記すること
```

---

### 2.2 アプローチB: Custom GPTs / Google Gems

**推薦者**: コンサルタントB

#### 概要

OpenAI Custom GPTs や Google Gems などの外部 AI サービスを活用し、DSL 仕様書を Knowledge/コンテキストとして学習させた上で、チャットフロー DSL を生成する。

#### アーキテクチャ

```
ユーザー（自然言語で要件記述）
    ↓
Custom GPT / Gem / Claude Project
    ↓ Knowledge参照（DSL仕様書・テンプレート）
DSL生成（JSON/YAML）
    ↓ Actions / API連携
Dify DSLインポートAPI
    ↓
Dify プラットフォームに新規チャットフロー作成
```

#### 3つのサブアプローチ比較

| 項目         | Custom GPTs             | Google Gems             | Claude Projects     |
| ------------ | ----------------------- | ----------------------- | ------------------- |
| LLM          | GPT-4o                  | Gemini 2.5              | Claude              |
| コンテキスト | Knowledge (20ファイル)  | 100万トークン           | 200Kトークン        |
| API連携      | Actions（直接連携可能） | 別途パイプライン必要    | 別途ツール必要      |
| UI           | ChatGPT（親しみやすい） | AI Studio（技術者向け） | Artifacts（視覚的） |
| 日本語       | 良好                    | 良好                    | 最も高品質          |

#### 構築手順

| ステップ | 内容                         | 期間  |
| -------- | ---------------------------- | ----- |
| Step 1   | DSL仕様書・テンプレート整備  | 3-5日 |
| Step 2   | Custom GPT / Gem 作成・設定  | 2-3日 |
| Step 3   | Dify API連携パイプライン構築 | 3-5日 |
| Step 4   | Slack Bot連携方法の整備      | 2-3日 |

#### Custom GPTs Actions の API連携設計

```yaml
openapi: 3.1.0
info:
  title: Dify DSL Import API
  version: 1.0.0
servers:
  - url: https://{dify-instance}/v1
paths:
  /apps/import:
    post:
      operationId: importDSL
      summary: Import a Dify chatflow DSL
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: string
                  description: YAML formatted DSL string
                mode:
                  type: string
                  enum: [yaml-dsl, json-dsl]
```

#### コスト分析（月額・5ユーザー想定）

| 項目         | Custom GPTs    | Google Gems       | Claude Projects |
| ------------ | -------------- | ----------------- | --------------- |
| ライセンス   | $125/月 (Team) | $100/月 (Premium) | $125/月 (Team)  |
| API利用料    | $5-15/月       | $3-10/月          | $10-20/月       |
| **月額合計** | **$130-140**   | **$103-110**      | **$110-125**    |

#### 3年間TCO比較

| 項目             | Custom GPTs       | Google Gems       | Claude Projects     |
| ---------------- | ----------------- | ----------------- | ------------------- |
| 初期開発         | 45-75万円         | 60-90万円         | 52.5-80万円         |
| 月額費用×36ヶ月  | 約68万円          | 約54万円          | 約61万円            |
| 年次メンテナンス | 約30万円          | 約45万円          | 約30万円            |
| **3年間TCO**     | **約143-173万円** | **約159-189万円** | **約143.5-171万円** |

---

### 2.3 アプローチC: 専用Difyツール（chatflow_generator プラグイン）開発

**推薦者**: コンサルタントC

#### 概要

本リポジトリの `tools/` ディレクトリ配下に `chatflow_generator/` として新規 Dify カスタムプラグインを開発し、既存アーキテクチャに完全統合する。

#### アーキテクチャ

```
ユーザー（自然言語で要件記述）
    ↓
Dify Agent / Slack Bot
    ↓ ツール呼び出し
chatflow_generator プラグイン
    ↓ [1] 意図解析（LLM）
    ↓ [2] テンプレート選択
    ↓ [3] DSL生成（LLM + テンプレート ハイブリッド）
    ↓ [4] バリデーション
    ↓ [5] (オプション) Dify APIインポート
検証済みDSL YAML / 自動デプロイ
```

#### プラグイン構成

```
tools/chatflow_generator/
├── manifest.yaml
├── provider/chatflow_generator.yaml
├── tools/
│   ├── generate_chatflow.py      # 自然言語 → DSL生成
│   ├── generate_chatflow.yaml
│   ├── validate_dsl.py            # DSLバリデーション
│   ├── validate_dsl.yaml
│   ├── list_templates.py          # テンプレート一覧
│   └── list_templates.yaml
├── services/
│   ├── dsl_generator.py           # DSL生成コアロジック
│   ├── dsl_validator.py           # バリデーションロジック
│   ├── node_catalog.py            # ノードタイプカタログ
│   └── templates/                 # DSLテンプレート集
│       ├── simple_chatbot.yaml
│       ├── qa_with_knowledge.yaml
│       └── multi_tool_agent.yaml
├── tests/
├── main.py
├── pyproject.toml
└── requirements.txt
```

#### manifest.yaml 設計

```yaml
version: 0.0.1
type: plugin
author: mixi
name: chatflow_generator
label:
  ja_JP: チャットフロー生成
description:
  ja_JP: 自然言語の記述からDifyチャットフローDSLを生成する。
resource:
  memory: 268435456
  permission:
    tool:
      enabled: true
    model:
      enabled: true
      llm: true          # DSL生成にLLM使用
    app:
      enabled: false
    storage:
      enabled: true       # テンプレートキャッシュ用
      size: 1048576
```

#### 開発計画

| フェーズ | 内容                                 | 期間        |
| -------- | ------------------------------------ | ----------- |
| Phase 1  | DSLスキーマ定義とバリデーター        | 2-3日       |
| Phase 2  | テンプレートエンジンとノードカタログ | 3-4日       |
| Phase 3  | LLM連携によるDSL生成                 | 3-4日       |
| Phase 4  | Dify APIインポート連携               | 2-3日       |
| Phase 5  | テスト・品質ゲート通過               | 2-3日       |
| **合計** |                                      | **12-17日** |

#### Slack Bot 連携シナリオ

```
Slack: "@bot 顧客対応用のチャットフローを作って。ナレッジ検索とJira連携付きで"
  ↓
Slack Bot Plugin → Dify Agent
  ↓
Dify Agent → chatflow_generator ツール呼び出し
  ↓
chatflow_generator: DSL生成 → バリデーション → Difyインポート
  ↓
Slack Bot Plugin → Slackスレッド返信
  "チャットフロー「顧客対応フロー」を生成しました。"
```

---

## 3. 比較マトリクス

### 3.1 5段階評価比較

| 評価軸                 | A: Agent+ナレッジ | B: Custom GPTs | B: Gems | C: 専用ツール |
| ---------------------- | :---------------: | :------------: | :-----: | :-----------: |
| 技術的実現可能性       |         4         |       5        |    4    |       4       |
| 導入コスト・開発工数   |       **5**       |       4        |    4    |       3       |
| 運用・保守性           |         3         |       4        |    3    |     **4**     |
| ユーザー体験（UX）     |         4         |     **5**      |    4    |     **5**     |
| スケーラビリティ       |         3         |       4        |  **5**  |       4       |
| 既存プロジェクト親和性 |         4         |       5        |    3    |     **5**     |
| **総合**               |      **3.8**      |    **4.5**     | **3.8** |    **4.2**    |

### 3.2 特性比較

| 比較項目          |   A: Agent+ナレッジ    |    B: Custom GPTs    |       C: 専用ツール        |
| ----------------- | :--------------------: | :------------------: | :------------------------: |
| 新規コード開発    |          不要          |        最小限        |      必要（12-17日）       |
| DSLバリデーション |    なし（LLM依存）     |   なし（LLM依存）    | あり（プログラマティック） |
| Dify API自動連携  |          手動          |    Actions で可能    |        直接連携可能        |
| データ主権        |     自社環境内完結     |   外部サービス経由   |       自社環境内完結       |
| TDD/品質ゲート    |         対象外         |        対象外        |          完全準拠          |
| テスト可能性      |          困難          |         困難         |    TDDで完全テスト可能     |
| バージョン管理    | ナレッジDB（追跡困難） | プラットフォーム依存 |    Git（差分管理可能）     |
| 初期導入コスト    |          最小          |          中          |            最大            |
| ランニングコスト  |     Dify LLM契約内     |     月額$130-140     |       Dify LLM契約内       |

---

## 4. 相互レビュー結果

### 4.1 アプローチAへの批評

**コンサルタントBからの指摘**:
- DSL生成精度はDify経由で間接的にLLMを利用するため、プロンプト設計の自由度が制限される
- 仕様変更への追従にナレッジベースの再構築が必要

**コンサルタントCからの指摘**:
- 生成されたDSLの構造的正確性を保証する手段がない
- プロンプトの出力テストが困難で、品質の再現性に課題
- バージョン管理（ナレッジDB・プロンプトの変更追跡）が困難

**コンサルタントAの反論**:
- PoC として最もコスト効率が高く、ここで蓄積したナレッジを他アプローチに引き継げる
- Difyエコシステム内で完結し、外部依存がないためセキュリティ面で優位

### 4.2 アプローチBへの批評

**コンサルタントAからの指摘**:
- 外部サービスにデータを送信するため、企業のセキュリティポリシーに抵触する可能性
- 追加の API 利用料金（月額$130-140）が発生

**コンサルタントCからの指摘**:
- 「生成→コピー→Difyインポート」の手作業が残る（Actions利用でも完全自動化は困難）
- 既存リポジトリの開発規約（TDD, 品質ゲート）との整合性がない
- ベンダーロックインリスク

**コンサルタントBの反論**:
- Actions による Dify API 直接連携で一気通貫ワークフローが実現可能
- 開発チームの工数を既存プラグイン機能拡張に集中投下できる
- ChatGPT の普及率により、非エンジニアも含めたチーム全体での活用が容易

### 4.3 アプローチCへの批評

**コンサルタントAからの指摘**:
- 12-17日の開発工数は他アプローチの「設定のみ」と比較して大きい
- DSLスキーマの網羅的解析に予想以上の工数がかかる可能性

**コンサルタントBからの指摘**:
- コード修正 → テスト → レビュー → デプロイのサイクルが重い
- Dify SDK バージョンアップへの追従コストが継続的に発生

**コンサルタントCの反論**:
- 既存の開発パターン（Toolクラス継承、manifest.yaml）をそのまま適用でき、学習コスト最小
- バリデーション層による品質保証は他アプローチにない明確な優位性
- .difypkg としてパッケージ化・配布可能

---

## 5. 推奨事項

### 5.1 推奨ロードマップ

```
【Phase 1: PoC — Dify Agent + ナレッジ】（3-4週間）
  目標: 最小コストで自然言語→DSL生成の実現可能性を検証
  成果物: ナレッジベース、Agentアプリ、生成品質レポート
  判断基準: 基本フロー（3-5ノード）の生成成功率 70% 以上
    ↓
【Phase 2: UX拡張 — Custom GPTs 併用】（2-3週間）
  目標: 非エンジニアも利用可能なUI提供、API直接連携
  成果物: Custom GPT、Dify API連携パイプライン
  判断基準: エンドツーエンドでの自動インポート成功
    ↓
【Phase 3: 本格実装 — 専用Difyツール開発】（12-17日）
  目標: 品質保証付きのDifyネイティブ統合
  成果物: chatflow_generator プラグイン（.difypkg）
  前提: Phase 1-2 で蓄積したナレッジ・テンプレートを活用
```

### 5.2 推奨理由

1. **リスク最小化**: Phase 1 で技術的実現可能性を低コストで検証してから本格投資
2. **知見の蓄積**: 各フェーズの成果物（ナレッジ、テンプレート、プロンプト）が次フェーズの基盤に
3. **段階的価値提供**: 各フェーズ完了時点で利用可能な成果物が得られる
4. **最終的な品質保証**: Phase 3 で TDD・品質ゲートに準拠した本格実装を実現

### 5.3 即座に着手すべきアクション

1. **Dify DSL スキーマの調査・文書化**（全アプローチ共通の前提作業）
2. **既存チャットフローの DSL エクスポート**（テンプレート素材の収集）
3. **PoC 用ナレッジベースの初期構築**（Phase 1 着手）

---

## 6. 技術付録

### 6.1 Dify チャットフロー DSL 構造

Dify チャットフローは以下の DSL 構造で定義される:

| 要素               | 説明                                                                 |
| ------------------ | -------------------------------------------------------------------- |
| **ノード**         | Start, LLM, Knowledge Retrieval, Tool, IF/ELSE, Code, Answer, End 等 |
| **エッジ**         | ノード間の接続（source_node_id → target_node_id）                    |
| **変数マッピング** | ノード間のデータ受け渡し `{{#nodeId.variableName#}}`                 |
| **形式**           | YAML/JSON でのエクスポート/インポートが可能                          |

### 6.2 Dify API エンドポイント（DSL関連）

| エンドポイント          | メソッド | 用途                          |
| ----------------------- | -------- | ----------------------------- |
| `/apps/import`          | POST     | DSL YAML/JSON のインポート    |
| `/apps/{app_id}/export` | GET      | 既存フローの DSL エクスポート |
| `/apps`                 | GET      | アプリ一覧取得                |

### 6.3 既存プラグインとの連携ポイント

| プラグイン | ファイル                  | 連携ポイント                                              |
| ---------- | ------------------------- | --------------------------------------------------------- |
| Slack Bot  | `endpoints/slack.py` L208 | `self.session.app.chat.invoke()` でDify Chat Flow呼び出し |
| Slack Bot  | `manifest.yaml`           | `app.enabled: true` でAgentモード対応                     |
| Jira       | `tools/search_issue.py`   | `Tool` クラス継承、`_invoke` メソッドパターン             |
| Jira       | `manifest.yaml`           | 21種のツール定義パターン                                  |

### 6.4 リスクサマリ

| リスク           | 影響度 | 関連アプローチ | 緩和策                                     |
| ---------------- | ------ | -------------- | ------------------------------------------ |
| DSL生成精度不足  | 高     | 全アプローチ   | テンプレート拡充、Few-shot、バリデーション |
| Dify DSL仕様変更 | 高     | 全アプローチ   | バージョン管理、定期監視                   |
| 外部サービス依存 | 中     | B              | デュアル運用、ローカルバックアップ         |
| データ主権       | 高     | B              | A/C を優先、または Enterprise プラン       |
| 開発工数超過     | 中     | C              | フェーズ分割、Phase 1 での検証             |
| ナレッジ陳腐化   | 中     | A              | 更新ルーチン策定、担当者明確化             |

---

## 付記

本レポートは以下の3名のコンサルタントエージェントによる独立分析を統合したものである:

- **コンサルタントA**: Dify Agent + ナレッジベース（RAG）アプローチ推薦
- **コンサルタントB**: Custom GPTs / Google Gems / Claude Projects アプローチ推薦
- **コンサルタントC**: 専用 Dify プラグイン（chatflow_generator）開発アプローチ推薦

各コンサルタントは `/workspace/tools/slack_bot/`、`/workspace/tools/jira/`、`/workspace/steering/slack_bot.md`、`/workspace/.specify/memory/constitution.md` 等の既存プロジェクト資産を参照した上で分析を実施した。
```
:::

金額や工数は精査が必要として、興味深いレポートが得られました。
比較マトリクスや推奨ロードマップと理由、相互レビューまでしていて驚きです。
真剣にやるのであれば、複数回 Agent Team 同士で会話させるのが良さそうですが、今回は「Dify Agent + ナレッジベース（RAG）アプローチ」を採用しました。

## Claude Code で作る

計画を基に `Dify DSL Generator` を作ります。
ここも Claude Code に作ってもらいます。

```
Dify 内部機能であるエージェント、ナレッジ、ワークフローを使って `Dify DSL Generator` を作る計画を作成して。
ユーザーインターフェースはエージェントを予定。
DSL の知識はナレッジに格納する。
DSL を生成する処理はワークフローで実現する。

# ユーザーの入力
- 構築したい業務フロー
- 業務フローの目的、ユーザー体験
- アウトカム
この3つが揃っていることが条件、揃うまでユーザーに問いかけを繰り返す

# 出力する DSL
YAML形式。チャットにそのまま出力し、ユーザーが自分で YAML ファイルに保存する。
```

暫く待つと4つのファイルが作成されました。

| #   | ファイル          | 内容                                                                                         |
| --- | ----------------- | -------------------------------------------------------------------------------------------- |
| 1   | dsl-schema.md     | DSL YAML トップレベル構造、ノード/エッジ共通フィールド、features 設定                        |
| 2   | node-catalog.md   | 16種のノードタイプの設定スキーマ、入出力仕様、YAML例                                         |
| 3   | dsl-templates.md  | 5パターンの完全DSL YAMLテンプレート（シンプルLLM、RAG QA、ツール連携、質問分類、バッチ処理） |
| 4   | variable-rules.md | 変数参照記法、各ノードの出力フィールド、接続ルール、ベストプラクティス                       |

:::details dsl-schema.md
```markdown
# Dify DSL スキーマ定義

本文書は Dify アプリケーション DSL（Domain Specific Language）の YAML 形式スキーマを定義する。
DSL はチャットフロー（advanced-chat）およびワークフロー（workflow）のエクスポート/インポートに使用される。

---

## 1. トップレベル構造

```yaml
version: "0.5.0"          # DSL バージョン（必須）
kind: "app"                # リソース種別（必須、常に "app"）
app:                       # アプリケーション基本情報（必須）
  name: "アプリ名"
  mode: "advanced-chat"    # アプリモード（必須）
  icon: "🤖"               # アイコン（絵文字または画像URL）
  icon_background: "#FFEAD5"
  description: "アプリの説明"
  use_icon_as_answer_icon: false
workflow:                  # ワークフロー定義（必須）
  graph: { ... }           # グラフ構造（ノード・エッジ）
  features: { ... }        # 機能設定
  environment_variables: [] # 環境変数
  conversation_variables: [] # 会話変数
dependencies: []           # プラグイン依存関係（任意）
```

## 2. app セクション

| フィールド                | 型      | 必須 | 説明                                                               |
| ------------------------- | ------- | ---- | ------------------------------------------------------------------ |
| `name`                    | string  | 必須 | アプリケーション表示名                                             |
| `mode`                    | enum    | 必須 | `advanced-chat`（チャットフロー）または `workflow`（ワークフロー） |
| `icon`                    | string  | 必須 | 絵文字（例: "🤖"）または画像URLパス                                 |
| `icon_background`         | string  | 任意 | アイコン背景色（hex形式、例: "#FFEAD5"）                           |
| `description`             | string  | 任意 | アプリの説明文                                                     |
| `use_icon_as_answer_icon` | boolean | 任意 | 回答時にアプリアイコンを使用するか（デフォルト: false）            |

### app.mode の選択基準

| モード         | 値              | 用途                                                                |
| -------------- | --------------- | ------------------------------------------------------------------- |
| チャットフロー | `advanced-chat` | 会話型アプリ。ユーザーと対話しながら処理する。Answer ノードで応答。 |
| ワークフロー   | `workflow`      | バッチ処理型。入力を受けて処理し結果を返す。End ノードで終了。      |

## 3. workflow セクション

### 3.1 graph（グラフ構造）

```yaml
workflow:
  graph:
    nodes:        # ノード配列（必須）
      - id: "node-uuid-1"
        data:
          type: "start"
          # ... ノードタイプ別の設定
        height: 54
        position:
          x: 80
          y: 282
        positionAbsolute:
          x: 80
          y: 282
        type: "custom"
        width: 244
    edges:        # エッジ配列（必須）
      - id: "edge-uuid-1"
        data:
          isInIteration: false
          sourceType: "start"
          targetType: "llm"
        source: "node-uuid-1"
        sourceHandle: "source"
        target: "node-uuid-2"
        targetHandle: "target"
        type: "custom"
    viewport:     # ビューポート設定
      x: 0
      y: 0
      zoom: 1
```

### 3.2 ノード共通フィールド

| フィールド         | 型     | 必須 | 説明                                            |
| ------------------ | ------ | ---- | ----------------------------------------------- |
| `id`               | string | 必須 | ノードの一意識別子（UUID v4 推奨）              |
| `data`             | object | 必須 | ノード設定（type フィールドでノード種別を指定） |
| `data.type`        | enum   | 必須 | ノードタイプ（start, llm, code 等）             |
| `data.title`       | string | 任意 | ノード表示名                                    |
| `data.desc`        | string | 任意 | ノード説明文                                    |
| `height`           | number | 必須 | ノード高さ（ピクセル）                          |
| `width`            | number | 必須 | ノード幅（ピクセル、標準: 244）                 |
| `position`         | object | 必須 | ノード位置 `{x: number, y: number}`             |
| `positionAbsolute` | object | 必須 | 絶対位置（通常 position と同じ）                |
| `type`             | string | 必須 | 常に `"custom"`                                 |

### 3.3 エッジフィールド

| フィールド     | 型     | 必須 | 説明                                  |
| -------------- | ------ | ---- | ------------------------------------- |
| `id`           | string | 必須 | エッジの一意識別子                    |
| `source`       | string | 必須 | 接続元ノードID                        |
| `sourceHandle` | string | 必須 | 接続元ハンドル（通常 `"source"`）     |
| `target`       | string | 必須 | 接続先ノードID                        |
| `targetHandle` | string | 必須 | 接続先ハンドル（通常 `"target"`）     |
| `type`         | string | 必須 | 常に `"custom"`                       |
| `data`         | object | 任意 | メタ情報（sourceType, targetType 等） |

### 3.4 IF/ELSE ノードのエッジハンドル

IF/ELSE ノードからのエッジは特殊なハンドルを使用する:

```yaml
# true 分岐
- source: "if-else-node-id"
  sourceHandle: "true"
  target: "true-branch-node-id"
  targetHandle: "target"

# false 分岐
- source: "if-else-node-id"
  sourceHandle: "false"
  target: "false-branch-node-id"
  targetHandle: "target"
```

### 3.5 features（機能設定）

```yaml
workflow:
  features:
    file_upload:
      allowed_file_extensions: []
      allowed_file_types: []
      allowed_file_upload_methods: []
      enabled: false
      max_length: 0
      number_limits: 0
    opening_statement: "こんにちは！何かお手伝いできることはありますか？"
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ""
      voice: ""
```

## 4. dependencies セクション

プラグイン依存関係を定義する。ツールノードで外部プラグインを使用する場合に必要。

```yaml
dependencies:
  - type: "plugin"
    value: "langgenius/jira_custom:0.0.7"
  - type: "plugin"
    value: "langgenius/slack_bot:0.0.12"
```

## 5. ノード配置の推奨値

| 項目                       | 推奨値                               |
| -------------------------- | ------------------------------------ |
| 開始X座標                  | 80                                   |
| ノード間隔（水平）         | 330                                  |
| ノード間隔（垂直、分岐時） | 200                                  |
| 標準幅                     | 244                                  |
| 標準高さ                   | 54（Start）、98（LLM）、90（Code）等 |

## 6. バージョン互換性

| DSL version | 対応 Dify バージョン | 備考                                        |
| ----------- | -------------------- | ------------------------------------------- |
| 0.1.5       | ～ 0.x 系            | 旧バージョン                                |
| 0.6.0       | 1.x 系               | 現行バージョン。dependencies セクション追加 |

DSL バージョンが Dify インスタンスより新しい場合、インポート時に確認ダイアログが表示される。
```
:::

:::details node-catalog.md
```markdown
# Dify ノードタイプカタログ

本文書は Dify ワークフロー/チャットフローで利用可能な全ノードタイプの仕様を定義する。

---

## ノードタイプ一覧

| #   | ノードタイプ                   | data.type             | 用途                           | 対応モード         |
| --- | ------------------------------ | --------------------- | ------------------------------ | ------------------ |
| 1   | Start                          | `start`               | フロー開始・入力変数定義       | 両方               |
| 2   | End                            | `end`                 | 処理終了・出力定義             | workflow のみ      |
| 3   | Answer                         | `answer`              | 応答テキスト出力               | advanced-chat のみ |
| 4   | LLM                            | `llm`                 | 言語モデル処理                 | 両方               |
| 5   | Knowledge Retrieval            | `knowledge-retrieval` | ナレッジベース検索（RAG）      | 両方               |
| 6   | IF/ELSE                        | `if-else`             | 条件分岐                       | 両方               |
| 7   | Code                           | `code`                | Python/JavaScript 実行         | 両方               |
| 8   | Template Transform             | `template-transform`  | Jinja2 テンプレート変換        | 両方               |
| 9   | Question Classifier            | `question-classifier` | 質問分類（LLMベース）          | 両方               |
| 10  | HTTP Request                   | `http-request`        | 外部API呼び出し                | 両方               |
| 11  | Tool                           | `tool`                | 外部ツール呼び出し             | 両方               |
| 12  | Variable Aggregator            | `variable-aggregator` | 変数集約                       | 両方               |
| 13  | Iteration                      | `iteration`           | 反復処理（配列要素の逐次処理） | 両方               |
| 14  | Loop                           | `loop`                | ループ処理（条件付き繰り返し） | 両方               |
| 15  | Parameter Extractor            | `parameter-extractor` | LLMによるパラメータ抽出        | 両方               |
| 16  | Conversation Variable Assigner | `assigner`            | 会話変数への値代入             | advanced-chat のみ |
| 17  | Tool                           | `custom`              | Jira チケット起票              | 両方               |

---

## 各ノード詳細

### 1. Start ノード

フローの開始点。ユーザー入力変数を定義する。全フローに必ず1つ存在する。

```yaml
data:
  type: start
  title: 開始
  variables:
    - label: ユーザー入力
      max_length: 256
      options: []
      required: true
      type: paragraph      # paragraph | short-text | number | select
      variable: user_input
```

**入力変数の型**:
| 型           | 説明                     |
| ------------ | ------------------------ |
| `short-text` | 短いテキスト入力         |
| `paragraph`  | 長いテキスト入力         |
| `number`     | 数値入力                 |
| `select`     | 選択肢（options で定義） |

### 2. End ノード（Workflow 用）

ワークフローの終了点。出力変数を定義する。

```yaml
data:
  type: end
  title: 終了
  outputs:
    - value_selector:
        - llm_node_id
        - text
      variable: result
```

### 3. Answer ノード（Chatflow 用）

チャットフローの応答出力。テンプレート文字列で他ノードの出力を参照できる。

```yaml
data:
  type: answer
  title: 回答
  answer: "{{#llm_node_id.text#}}"
```

### 4. LLM ノード

言語モデルを呼び出してテキスト生成を行う。

```yaml
data:
  type: llm
  title: LLM
  model:
    provider: openai       # モデルプロバイダ
    name: gpt-4o           # モデル名
    mode: chat             # chat | completion
    completion_params:
      temperature: 0.7
      max_tokens: 4096
      top_p: 1
  prompt_template:
    - role: system
      text: "あなたは親切なアシスタントです。"
    - role: user
      text: "{{#start.user_input#}}"
  context:
    enabled: true
    variable_selector:
      - knowledge_retrieval_node_id
      - result
  vision:
    enabled: false
  memory:
    role_prefix:
      assistant: ""
      user: ""
    window:
      enabled: false
      size: 10
```

**主要設定項目**:
| 設定                                  | 説明                                                |
| ------------------------------------- | --------------------------------------------------- |
| `model.provider`                      | LLMプロバイダ（openai, anthropic, azure_openai 等） |
| `model.name`                          | モデル名（gpt-4o, claude-sonnet-4-5-20250929 等）   |
| `model.completion_params.temperature` | 生成の多様性（0.0〜2.0）                            |
| `prompt_template`                     | プロンプト配列（role + text）                       |
| `context`                             | ナレッジ検索結果の参照設定                          |
| `memory`                              | 会話メモリ設定（Chatflow のみ有効）                 |

### 5. Knowledge Retrieval ノード

ナレッジベース（Knowledge Base）からベクトル検索を行う。

```yaml
data:
  type: knowledge-retrieval
  title: ナレッジ検索
  dataset_ids:
    - "dataset-uuid-1"
    - "dataset-uuid-2"
  query_variable_selector:
    - start
    - user_input
  retrieval_mode: multiple    # single | multiple
  multiple_retrieval_config:
    reranking_enable: true
    reranking_mode: weighted_score
    score_threshold: null
    score_threshold_enabled: false
    top_k: 5
    weights:
      keyword_setting:
        keyword_weight: 0.3
      vector_setting:
        embedding_provider_name: openai
        vector_weight: 0.7
  single_retrieval_config:
    model:
      provider: openai
      name: gpt-4o
      mode: chat
      completion_params:
        temperature: 0
```

### 6. IF/ELSE ノード

条件に基づいてフローを分岐する。

```yaml
data:
  type: if-else
  title: 条件分岐
  conditions:
    - comparison_operator: contains    # contains | not-contains | is | is-not | empty | not-empty | ...
      id: "condition-uuid"
      value: "エラー"
      varType: string
      variable_selector:
        - llm_node_id
        - text
  logical_operator: and    # and | or
```

**比較演算子**:
| 演算子                            | 説明         |
| --------------------------------- | ------------ |
| `contains`                        | 値を含む     |
| `not-contains`                    | 値を含まない |
| `is`                              | 完全一致     |
| `is-not`                          | 不一致       |
| `empty`                           | 空である     |
| `not-empty`                       | 空でない     |
| `start-with`                      | で始まる     |
| `end-with`                        | で終わる     |
| `=` / `≠` / `>` / `<` / `≥` / `≤` | 数値比較     |

**エッジハンドル**: true 分岐は `sourceHandle: "true"`、false 分岐は `sourceHandle: "false"`

### 7. Code ノード

Python または JavaScript コードを実行する。

```yaml
data:
  type: code
  title: コード実行
  code: |
    def main(input_text: str) -> dict:
        result = input_text.upper()
        return {"output": result}
  code_language: python3    # python3 | javascript
  dependencies: []
  outputs:
    output:
      children: null
      type: string
  variables:
    - value_selector:
        - start
        - user_input
      variable: input_text
```

**制約**:
- Python: `main()` 関数を定義し、dict を返す
- JavaScript: `main()` 関数を定義し、オブジェクトを返す
- 外部ライブラリのインポートは制限あり（yaml, json, re 等の標準ライブラリは使用可能）

### 8. Template Transform ノード

Jinja2 テンプレートで変数を変換する。

```yaml
data:
  type: template-transform
  title: テンプレート変換
  template: |
    ## 回答
    質問: {{query}}
    回答: {{answer}}
  variables:
    - value_selector:
        - start
        - user_input
      variable: query
    - value_selector:
        - llm_node_id
        - text
      variable: answer
```

### 9. Question Classifier ノード

LLMを使って質問を分類する。

```yaml
data:
  type: question-classifier
  title: 質問分類
  classes:
    - id: "class-uuid-1"
      name: "技術質問"
    - id: "class-uuid-2"
      name: "業務質問"
    - id: "class-uuid-3"
      name: "その他"
  instructions: "ユーザーの質問を適切なカテゴリに分類してください。"
  model:
    provider: openai
    name: gpt-4o
    mode: chat
    completion_params:
      temperature: 0
  query_variable_selector:
    - start
    - user_input
```

**エッジハンドル**: 各クラスの `id` が `sourceHandle` として使用される。

### 10. HTTP Request ノード

外部APIを呼び出す。

```yaml
data:
  type: http-request
  title: API呼び出し
  method: post             # get | post | put | patch | delete
  url: "https://api.example.com/endpoint"
  headers: "Content-Type: application/json"
  params: ""
  body:
    type: json             # json | raw-text | form-data | x-www-form-urlencoded | none
    data:
      - key: "query"
        type: text
        value: "{{#start.user_input#}}"
  authorization:
    type: api-key          # no-auth | api-key | custom
    config:
      api_key: ""
      header: "Authorization"
      type: bearer
  timeout:
    connect: 10
    read: 60
    write: 10
```

### 11. Tool ノード

Dify に登録されたツール（プラグイン含む）を呼び出す。

```yaml
data:
  type: tool
  title: Jira チケット作成
  provider_id: jira_custom
  provider_name: jira_custom
  provider_type: api
  tool_name: create_issue
  tool_label: Create Issue
  tool_configurations: {}
  tool_parameters:
    project_key:
      type: mixed
      value: "PROJ"
    summary:
      type: mixed
      value: "{{#llm_node_id.text#}}"
```

### 12. Variable Aggregator ノード

複数の分岐からの変数を1つに集約する。

```yaml
data:
  type: variable-aggregator
  title: 変数集約
  variables:
    - - branch_a_node_id
      - output
    - - branch_b_node_id
      - output
  output_type: string
  advanced_settings:
    group_enabled: false
```

### 13. Iteration ノード

配列の各要素に対して内部フローを繰り返し実行する。

```yaml
data:
  type: iteration
  title: イテレーション
  iterator_selector:
    - code_node_id
    - items
  output_selector:
    - inner_llm_node_id
    - text
  output_type: array[string]
  is_parallel: false
  parallel_nums: 10
  error_handle_mode: terminated    # terminated | continue-on-error | remove-abnormal-output
```

**内部ノード**: Iteration ノード内に配置されるノードは `isInIteration: true` フラグを持つ。

### 17. Jira チケット起票ノード

Jira チケットを起票する

```yaml
data:
  is_team_authorization: true
  paramSchemas:
  - auto_generate: null
    default: ''
    form: llm
    human_description:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    label:
      en_US: inputDescription
      ja_JP: inputDescription
      pt_BR: inputDescription
      zh_Hans: inputDescription
    llm_description: ''
    max: null
    min: null
    name: inputDescription
    options: []
    placeholder:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    precision: null
    required: true
    scope: null
    template: null
    type: string
  - auto_generate: null
    default: ''
    form: llm
    human_description:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    label:
      en_US: inputProject
      ja_JP: inputProject
      pt_BR: inputProject
      zh_Hans: inputProject
    llm_description: ''
    max: null
    min: null
    name: inputProject
    options: []
    placeholder:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    precision: null
    required: true
    scope: null
    template: null
    type: string
  - auto_generate: null
    default: ''
    form: llm
    human_description:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    label:
      en_US: inputSummary
      ja_JP: inputSummary
      pt_BR: inputSummary
      zh_Hans: inputSummary
    llm_description: ''
    max: null
    min: null
    name: inputSummary
    options: []
    placeholder:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    precision: null
    required: true
    scope: null
    template: null
    type: string
  - auto_generate: null
    default: ''
    form: llm
    human_description:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    label:
      en_US: inputType
      ja_JP: inputType
      pt_BR: inputType
      zh_Hans: inputType
    llm_description: ''
    max: null
    min: null
    name: inputType
    options: []
    placeholder:
      en_US: ''
      ja_JP: ''
      pt_BR: ''
      zh_Hans: ''
    precision: null
    required: true
    scope: null
    template: null
    type: string
  params:
    inputDescription: ''
    inputProject: ''
    inputSummary: ''
    inputType: ''
  plugin_id: null
  plugin_unique_identifier: null
  provider_icon:
    background: '#FFEAD5'
    content: 🤖
  provider_id: e4b6bd66-b284-4d9e-a7b9-a5eb065fb61c
  provider_name: Jira チケット起票
  provider_type: workflow
  selected: false
  title: Jira チケット起票 入社処理
  tool_configurations: {}
  tool_description: Jira チケットを起票するフローです
  tool_label: Jira チケット起票
  tool_name: create_jira_issue
  tool_node_version: '2'
  tool_parameters:
    inputDescription:
      type: mixed
      value: '{{#1771296954158.output#}}'
    inputProject:
      type: mixed
      value: TEST
    inputSummary:
      type: mixed
      value: Jira Bot Test
    inputType:
      type: mixed
      value: タスク
  type: tool
selected: false
sourcePosition: right
targetPosition: left
type: custom
```
```
:::

:::details dsl-templates.md
```markdown
# Dify DSL テンプレート集

本文書は代表的なチャットフロー/ワークフローパターンの DSL YAML テンプレートを格納する。
各テンプレートはユースケース説明、完全な YAML DSL、カスタマイズポイントを含む。

> **注意**: テンプレート内の UUID は例示用です。実際の使用時は新しい UUID を生成してください。
> また、`model.provider` と `model.name` は環境に合わせて変更してください。

---

## テンプレート 1: シンプル LLM 会話

### ユースケース
ユーザーの質問に LLM が直接回答するシンプルなチャットボット。
ナレッジベースやツールを使わず、LLM の知識のみで応答する。

### フロー構成
```
Start → LLM → Answer
```

### DSL YAML

```yaml
version: "0.5.0"
kind: "app"
app:
  name: "シンプル LLM チャットボット"
  mode: "advanced-chat"
  icon: "💬"
  icon_background: "#E4FBCC"
  description: "ユーザーの質問にLLMが直接回答するシンプルなチャットボット"
  use_icon_as_answer_icon: false
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: "こんにちは！何でもお気軽にご質問ください。"
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    suggested_questions:
      - "自己紹介をしてください"
      - "今日の天気を教えて"
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
      - id: "e1-start-to-llm"
        data:
          isInIteration: false
          sourceType: "start"
          targetType: "llm"
        source: "node-start"
        sourceHandle: "source"
        target: "node-llm"
        targetHandle: "target"
        type: "custom"
      - id: "e2-llm-to-answer"
        data:
          isInIteration: false
          sourceType: "llm"
          targetType: "answer"
        source: "node-llm"
        sourceHandle: "source"
        target: "node-answer"
        targetHandle: "target"
        type: "custom"
    nodes:
      - id: "node-start"
        data:
          type: "start"
          title: "開始"
          variables: []
        height: 54
        position:
          x: 80
          y: 282
        positionAbsolute:
          x: 80
          y: 282
        type: "custom"
        width: 244
      - id: "node-llm"
        data:
          type: "llm"
          title: "LLM"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.7
              max_tokens: 4096
              top_p: 1
          prompt_template:
            - role: "system"
              text: "あなたは親切で知識豊富なアシスタントです。ユーザーの質問に日本語で丁寧に回答してください。"
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: false
          vision:
            enabled: false
          memory:
            role_prefix:
              assistant: ""
              user: ""
            window:
              enabled: true
              size: 10
        height: 98
        position:
          x: 410
          y: 282
        positionAbsolute:
          x: 410
          y: 282
        type: "custom"
        width: 244
      - id: "node-answer"
        data:
          type: "answer"
          title: "回答"
          answer: "{{#node-llm.text#}}"
        height: 107
        position:
          x: 740
          y: 282
        positionAbsolute:
          x: 740
          y: 282
        type: "custom"
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 1
```

### カスタマイズポイント
- `prompt_template[0].text`: システムプロンプトを用途に合わせて変更
- `model.name`: 使用するLLMモデルを変更
- `memory.window.size`: 会話履歴の参照数を調整
- `opening_statement`: 初期メッセージを変更
- `suggested_questions`: 提案質問を変更

---

## テンプレート 2: ナレッジ検索付き QA

### ユースケース
社内 FAQ やドキュメントをナレッジベースに登録し、ユーザーの質問に対して
関連情報を検索（RAG）してから LLM が回答を生成する。

### フロー構成
```
Start → Knowledge Retrieval → LLM → Answer
```

### DSL YAML

```yaml
version: "0.5.0"
kind: "app"
app:
  name: "ナレッジ検索 QA ボット"
  mode: "advanced-chat"
  icon: "📚"
  icon_background: "#D5F5F6"
  description: "ナレッジベースを検索して質問に回答するQAチャットボット"
  use_icon_as_answer_icon: false
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: "社内ドキュメントに関する質問にお答えします。何でもお聞きください。"
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: true
    text_to_speech:
      enabled: false
  graph:
    edges:
      - id: "e1-start-to-kr"
        data:
          isInIteration: false
          sourceType: "start"
          targetType: "knowledge-retrieval"
        source: "node-start"
        sourceHandle: "source"
        target: "node-kr"
        targetHandle: "target"
        type: "custom"
      - id: "e2-kr-to-llm"
        data:
          isInIteration: false
          sourceType: "knowledge-retrieval"
          targetType: "llm"
        source: "node-kr"
        sourceHandle: "source"
        target: "node-llm"
        targetHandle: "target"
        type: "custom"
      - id: "e3-llm-to-answer"
        data:
          isInIteration: false
          sourceType: "llm"
          targetType: "answer"
        source: "node-llm"
        sourceHandle: "source"
        target: "node-answer"
        targetHandle: "target"
        type: "custom"
    nodes:
      - id: "node-start"
        data:
          type: "start"
          title: "開始"
          variables: []
        height: 54
        position:
          x: 80
          y: 282
        positionAbsolute:
          x: 80
          y: 282
        type: "custom"
        width: 244
      - id: "node-kr"
        data:
          type: "knowledge-retrieval"
          title: "ナレッジ検索"
          dataset_ids:
            - "<YOUR_DATASET_ID>"
          query_variable_selector:
            - "node-start"
            - "sys.query"
          retrieval_mode: "multiple"
          multiple_retrieval_config:
            reranking_enable: true
            reranking_mode: "weighted_score"
            score_threshold_enabled: false
            top_k: 5
            weights:
              keyword_setting:
                keyword_weight: 0.3
              vector_setting:
                vector_weight: 0.7
        height: 90
        position:
          x: 410
          y: 282
        positionAbsolute:
          x: 410
          y: 282
        type: "custom"
        width: 244
      - id: "node-llm"
        data:
          type: "llm"
          title: "LLM"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.3
              max_tokens: 4096
          prompt_template:
            - role: "system"
              text: |
                あなたは社内ドキュメントに基づいて回答するアシスタントです。
                以下のルールに従ってください：
                1. 提供されたコンテキスト情報のみに基づいて回答すること
                2. コンテキストに該当する情報がない場合は「該当する情報が見つかりませんでした」と回答すること
                3. 回答は簡潔かつ正確に、日本語で行うこと
                4. 参照元のドキュメント名がわかる場合は末尾に記載すること
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: true
            variable_selector:
              - "node-kr"
              - "result"
          vision:
            enabled: false
          memory:
            window:
              enabled: true
              size: 5
        height: 98
        position:
          x: 740
          y: 282
        positionAbsolute:
          x: 740
          y: 282
        type: "custom"
        width: 244
      - id: "node-answer"
        data:
          type: "answer"
          title: "回答"
          answer: "{{#node-llm.text#}}"
        height: 107
        position:
          x: 1070
          y: 282
        positionAbsolute:
          x: 1070
          y: 282
        type: "custom"
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 1
```

### カスタマイズポイント
- `dataset_ids`: 実際の Knowledge Base ID に置換する（必須）
- `multiple_retrieval_config.top_k`: 検索結果数を調整（多いほど網羅的だがコスト増）
- `prompt_template[0].text`: RAG 用システムプロンプトをドメインに合わせて調整
- `temperature`: 0.3（事実ベース回答向け）を推奨

---

## テンプレート 3: ツール連携フロー（条件分岐付き）

### ユースケース
ユーザーの入力を LLM で分析し、条件に応じて外部ツール（Jira チケット作成等）を
呼び出すか、テキスト回答を返すかを分岐する。

### フロー構成
```
Start → LLM（分析） → IF/ELSE
  ├─ true → Tool（Jira起票） → Answer（起票完了）
  └─ false → Answer（テキスト回答）
```

### DSL YAML

```yaml
version: "0.5.0"
kind: "app"
app:
  name: "ツール連携チャットボット"
  mode: "advanced-chat"
  icon: "🔧"
  icon_background: "#FFE4E1"
  description: "条件に応じてJiraチケットを自動作成する業務支援ボット"
  use_icon_as_answer_icon: false
dependencies:
  - type: "plugin"
    value: "langgenius/jira_custom:0.0.7"
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: "業務の問い合わせを受け付けます。バグ報告の場合はJiraチケットを自動作成します。"
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    suggested_questions:
      - "ログイン画面でエラーが発生しています"
      - "有給休暇の申請方法を教えてください"
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
      - id: "e1-start-to-llm"
        source: "node-start"
        sourceHandle: "source"
        target: "node-llm-analyze"
        targetHandle: "target"
        type: "custom"
      - id: "e2-llm-to-ifelse"
        source: "node-llm-analyze"
        sourceHandle: "source"
        target: "node-ifelse"
        targetHandle: "target"
        type: "custom"
      - id: "e3-ifelse-true-to-tool"
        source: "node-ifelse"
        sourceHandle: "true"
        target: "node-tool-jira"
        targetHandle: "target"
        type: "custom"
      - id: "e4-tool-to-answer-ticket"
        source: "node-tool-jira"
        sourceHandle: "source"
        target: "node-answer-ticket"
        targetHandle: "target"
        type: "custom"
      - id: "e5-ifelse-false-to-answer-text"
        source: "node-ifelse"
        sourceHandle: "false"
        target: "node-answer-text"
        targetHandle: "target"
        type: "custom"
    nodes:
      - id: "node-start"
        data:
          type: "start"
          title: "開始"
          variables: []
        height: 54
        position: { x: 80, y: 282 }
        positionAbsolute: { x: 80, y: 282 }
        type: "custom"
        width: 244
      - id: "node-llm-analyze"
        data:
          type: "llm"
          title: "入力分析"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.1
          prompt_template:
            - role: "system"
              text: |
                ユーザーの入力を分析し、以下のJSON形式で出力してください。
                {
                  "is_bug_report": true/false,
                  "summary": "要約（50文字以内）",
                  "description": "詳細説明",
                  "priority": "High/Medium/Low"
                }
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: false
          memory:
            window:
              enabled: true
              size: 5
        height: 98
        position: { x: 410, y: 282 }
        positionAbsolute: { x: 410, y: 282 }
        type: "custom"
        width: 244
      - id: "node-ifelse"
        data:
          type: "if-else"
          title: "バグ報告判定"
          conditions:
            - comparison_operator: "contains"
              id: "cond-1"
              value: "\"is_bug_report\": true"
              varType: "string"
              variable_selector:
                - "node-llm-analyze"
                - "text"
          logical_operator: "and"
        height: 126
        position: { x: 740, y: 282 }
        positionAbsolute: { x: 740, y: 282 }
        type: "custom"
        width: 244
      - id: "node-tool-jira"
        data:
          type: "tool"
          title: "Jira チケット作成"
          provider_id: "jira_custom"
          provider_name: "jira_custom"
          provider_type: "api"
          tool_name: "create_issue"
          tool_label: "Create Issue"
          tool_configurations: {}
          tool_parameters:
            project_key:
              type: "mixed"
              value: "BUG"
            summary:
              type: "mixed"
              value: "{{#node-llm-analyze.text#}}"
            issue_type:
              type: "mixed"
              value: "Bug"
        height: 178
        position: { x: 1070, y: 182 }
        positionAbsolute: { x: 1070, y: 182 }
        type: "custom"
        width: 244
      - id: "node-answer-ticket"
        data:
          type: "answer"
          title: "起票完了通知"
          answer: |
            Jira チケットを作成しました。

            {{#node-tool-jira.text#}}
        height: 107
        position: { x: 1400, y: 182 }
        positionAbsolute: { x: 1400, y: 182 }
        type: "custom"
        width: 244
      - id: "node-answer-text"
        data:
          type: "answer"
          title: "テキスト回答"
          answer: "{{#node-llm-analyze.text#}}"
        height: 107
        position: { x: 1070, y: 432 }
        positionAbsolute: { x: 1070, y: 432 }
        type: "custom"
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 1
```

### カスタマイズポイント
- `tool_parameters.project_key`: Jira プロジェクトキーを変更
- `conditions[0].value`: 分岐条件を業務に合わせて変更
- `prompt_template`: 分析プロンプトを業務要件に合わせて調整
- ツール種類の変更: Jira 以外のツール（Slack通知、メール送信等）に差し替え可能

---

## テンプレート 4: 質問分類による多分岐フロー

### ユースケース
ユーザーの質問を自動分類し、カテゴリに応じて異なる処理パスに振り分ける。
技術質問はナレッジ検索、業務質問は定型回答、その他は LLM で汎用回答する。

### フロー構成
```
Start → Question Classifier
  ├─ 技術質問 → Knowledge Retrieval → LLM → Answer
  ├─ 業務質問 → LLM（定型回答） → Answer
  └─ その他 → LLM（汎用回答） → Answer
```

### DSL YAML

```yaml
version: "0.5.0"
kind: "app"
app:
  name: "質問分類 QA ボット"
  mode: "advanced-chat"
  icon: "🏷️"
  icon_background: "#E8D5FF"
  description: "質問カテゴリに応じて最適な回答方法を選択するQAボット"
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    opening_statement: "技術的な質問、業務に関する質問、何でもお答えします。"
    retriever_resource:
      enabled: true
  graph:
    edges:
      - id: "e1"
        source: "node-start"
        sourceHandle: "source"
        target: "node-classifier"
        targetHandle: "target"
        type: "custom"
      - id: "e2-tech"
        source: "node-classifier"
        sourceHandle: "class-tech"
        target: "node-kr"
        targetHandle: "target"
        type: "custom"
      - id: "e3-kr-to-llm"
        source: "node-kr"
        sourceHandle: "source"
        target: "node-llm-tech"
        targetHandle: "target"
        type: "custom"
      - id: "e4-llm-tech-to-answer"
        source: "node-llm-tech"
        sourceHandle: "source"
        target: "node-answer-tech"
        targetHandle: "target"
        type: "custom"
      - id: "e5-biz"
        source: "node-classifier"
        sourceHandle: "class-biz"
        target: "node-llm-biz"
        targetHandle: "target"
        type: "custom"
      - id: "e6-llm-biz-to-answer"
        source: "node-llm-biz"
        sourceHandle: "source"
        target: "node-answer-biz"
        targetHandle: "target"
        type: "custom"
      - id: "e7-other"
        source: "node-classifier"
        sourceHandle: "class-other"
        target: "node-llm-other"
        targetHandle: "target"
        type: "custom"
      - id: "e8-llm-other-to-answer"
        source: "node-llm-other"
        sourceHandle: "source"
        target: "node-answer-other"
        targetHandle: "target"
        type: "custom"
    nodes:
      - id: "node-start"
        data:
          type: "start"
          title: "開始"
          variables: []
        height: 54
        position: { x: 80, y: 282 }
        positionAbsolute: { x: 80, y: 282 }
        type: "custom"
        width: 244
      - id: "node-classifier"
        data:
          type: "question-classifier"
          title: "質問分類"
          classes:
            - id: "class-tech"
              name: "技術質問"
            - id: "class-biz"
              name: "業務質問"
            - id: "class-other"
              name: "その他"
          instructions: |
            ユーザーの質問を以下のカテゴリに分類してください：
            - 技術質問: プログラミング、システム、インフラ、ツールに関する質問
            - 業務質問: 勤怠、経費、社内手続きに関する質問
            - その他: 上記に当てはまらない質問
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0
          query_variable_selector:
            - "node-start"
            - "sys.query"
        height: 178
        position: { x: 410, y: 282 }
        positionAbsolute: { x: 410, y: 282 }
        type: "custom"
        width: 244
      - id: "node-kr"
        data:
          type: "knowledge-retrieval"
          title: "技術ナレッジ検索"
          dataset_ids:
            - "<YOUR_TECH_DATASET_ID>"
          query_variable_selector:
            - "node-start"
            - "sys.query"
          retrieval_mode: "multiple"
          multiple_retrieval_config:
            top_k: 5
            reranking_enable: true
        height: 90
        position: { x: 740, y: 82 }
        positionAbsolute: { x: 740, y: 82 }
        type: "custom"
        width: 244
      - id: "node-llm-tech"
        data:
          type: "llm"
          title: "技術回答LLM"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.3
          prompt_template:
            - role: "system"
              text: "技術ドキュメントに基づいて正確に回答してください。"
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: true
            variable_selector:
              - "node-kr"
              - "result"
        height: 98
        position: { x: 1070, y: 82 }
        positionAbsolute: { x: 1070, y: 82 }
        type: "custom"
        width: 244
      - id: "node-answer-tech"
        data:
          type: "answer"
          title: "技術回答"
          answer: "{{#node-llm-tech.text#}}"
        height: 107
        position: { x: 1400, y: 82 }
        positionAbsolute: { x: 1400, y: 82 }
        type: "custom"
        width: 244
      - id: "node-llm-biz"
        data:
          type: "llm"
          title: "業務回答LLM"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.5
          prompt_template:
            - role: "system"
              text: "社内の業務手続きについて案内してください。勤怠システム、経費精算、各種申請について回答します。"
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: false
        height: 98
        position: { x: 740, y: 282 }
        positionAbsolute: { x: 740, y: 282 }
        type: "custom"
        width: 244
      - id: "node-answer-biz"
        data:
          type: "answer"
          title: "業務回答"
          answer: "{{#node-llm-biz.text#}}"
        height: 107
        position: { x: 1070, y: 282 }
        positionAbsolute: { x: 1070, y: 282 }
        type: "custom"
        width: 244
      - id: "node-llm-other"
        data:
          type: "llm"
          title: "汎用回答LLM"
          model:
            provider: "openai"
            name: "gpt-4o"
            mode: "chat"
            completion_params:
              temperature: 0.7
          prompt_template:
            - role: "system"
              text: "ユーザーの質問に親切に回答してください。"
            - role: "user"
              text: "{{#sys.query#}}"
          context:
            enabled: false
        height: 98
        position: { x: 740, y: 482 }
        positionAbsolute: { x: 740, y: 482 }
        type: "custom"
        width: 244
      - id: "node-answer-other"
        data:
          type: "answer"
          title: "汎用回答"
          answer: "{{#node-llm-other.text#}}"
        height: 107
        position: { x: 1070, y: 482 }
        positionAbsolute: { x: 1070, y: 482 }
        type: "custom"
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 1
```

### カスタマイズポイント
- `classes`: 分類カテゴリを業務に合わせて変更・追加
- `instructions`: 分類基準を具体的に記述
- `dataset_ids`: 各カテゴリ用のナレッジベースIDを設定
- 分岐先を増やす場合は classes にカテゴリを追加し、対応するノードとエッジを追加

---

## テンプレート 5: バッチ処理ワークフロー（Iteration 付き）

### ユースケース
入力テキストを行ごとに分割し、各行に対して LLM で処理を行い、
結果をまとめて出力するバッチ処理ワークフロー。

### フロー構成
```
Start → Code（テキスト分割） → Iteration[ LLM（各行処理）] → Code（結果結合） → End
```

### DSL YAML

```yaml
version: "0.5.0"
kind: "app"
app:
  name: "バッチ処理ワークフロー"
  mode: "workflow"
  icon: "⚙️"
  icon_background: "#FFF3CD"
  description: "入力テキストを行ごとに処理し結果をまとめて出力するワークフロー"
workflow:
  conversation_variables: []
  environment_variables: []
  features: {}
  graph:
    edges:
      - id: "e1"
        source: "node-start"
        sourceHandle: "source"
        target: "node-code-split"
        targetHandle: "target"
        type: "custom"
      - id: "e2"
        source: "node-code-split"
        sourceHandle: "source"
        target: "node-iteration"
        targetHandle: "target"
        type: "custom"
      - id: "e3"
        source: "node-iteration"
        sourceHandle: "source"
        target: "node-code-join"
        targetHandle: "target"
        type: "custom"
      - id: "e4"
        source: "node-code-join"
        sourceHandle: "source"
        target: "node-end"
        targetHandle: "target"
        type: "custom"
    nodes:
      - id: "node-start"
        data:
          type: "start"
          title: "開始"
          variables:
            - label: "入力テキスト"
              variable: "input_text"
              type: "paragraph"
              required: true
        height: 54
        position: { x: 80, y: 282 }
        positionAbsolute: { x: 80, y: 282 }
        type: "custom"
        width: 244
      - id: "node-code-split"
        data:
          type: "code"
          title: "テキスト分割"
          code: |
            def main(input_text: str) -> dict:
                lines = [line.strip() for line in input_text.split('\n') if line.strip()]
                return {"items": lines}
          code_language: "python3"
          outputs:
            items:
              type: "array[string]"
          variables:
            - value_selector:
                - "node-start"
                - "input_text"
              variable: "input_text"
        height: 90
        position: { x: 410, y: 282 }
        positionAbsolute: { x: 410, y: 282 }
        type: "custom"
        width: 244
      - id: "node-iteration"
        data:
          type: "iteration"
          title: "行ごと処理"
          iterator_selector:
            - "node-code-split"
            - "items"
          output_selector:
            - "node-iter-llm"
            - "text"
          output_type: "array[string]"
          is_parallel: false
          error_handle_mode: "continue-on-error"
          start_node_id: "node-iter-llm"
        height: 300
        position: { x: 740, y: 182 }
        positionAbsolute: { x: 740, y: 182 }
        type: "custom"
        width: 500
      - id: "node-iter-llm"
        data:
          type: "llm"
          title: "行処理LLM"
          model:
            provider: "openai"
            name: "gpt-4o-mini"
            mode: "chat"
            completion_params:
              temperature: 0.3
          prompt_template:
            - role: "system"
              text: "入力テキストを要約して1文にまとめてください。"
            - role: "user"
              text: "{{#node-iteration.item#}}"
          context:
            enabled: false
        height: 98
        position: { x: 800, y: 240 }
        positionAbsolute: { x: 800, y: 240 }
        type: "custom"
        width: 244
        parentId: "node-iteration"
        isInIteration: true
        iteration_id: "node-iteration"
      - id: "node-code-join"
        data:
          type: "code"
          title: "結果結合"
          code: |
            def main(results: list) -> dict:
                output = '\n'.join([f"- {r}" for r in results])
                return {"output": output}
          code_language: "python3"
          outputs:
            output:
              type: "string"
          variables:
            - value_selector:
                - "node-iteration"
                - "output"
              variable: "results"
        height: 90
        position: { x: 1320, y: 282 }
        positionAbsolute: { x: 1320, y: 282 }
        type: "custom"
        width: 244
      - id: "node-end"
        data:
          type: "end"
          title: "終了"
          outputs:
            - value_selector:
                - "node-code-join"
                - "output"
              variable: "result"
        height: 90
        position: { x: 1650, y: 282 }
        positionAbsolute: { x: 1650, y: 282 }
        type: "custom"
        width: 244
    viewport:
      x: 0
      y: 0
      zoom: 1
```

### カスタマイズポイント
- `node-code-split`: 分割ロジックを変更（CSV分割、JSON配列展開等）
- `node-iter-llm`: 各行に対する処理を変更（翻訳、分類、抽出等）
- `is_parallel`: true に設定すると並列処理（コスト注意）
- `error_handle_mode`: エラー時の動作を変更（`terminated` / `continue-on-error` / `remove-abnormal-output`）
- `model.name`: バッチ処理向けに `gpt-4o-mini` 等の軽量モデルを推奨
```

---

## テンプレート選択ガイド

| 要件                           | 推奨テンプレート               |
| ------------------------------ | ------------------------------ |
| シンプルな Q&A チャットボット  | テンプレート 1                 |
| ドキュメント検索付き Q&A       | テンプレート 2                 |
| 外部ツール連携（条件分岐）     | テンプレート 3                 |
| 質問カテゴリに応じた多分岐処理 | テンプレート 4                 |
| 一括処理・バッチ処理           | テンプレート 5                 |
| 上記の組み合わせ               | テンプレートを組み合わせて構築 |

```
:::

:::details variable-rules.md
```markdown
# Dify 変数マッピング・接続ルール

本文書は Dify ワークフロー/チャットフローにおける変数参照の記法とノード間接続のルールを定義する。

---

## 1. 変数参照記法

### 1.1 ノード出力の参照

ノード間でデータを受け渡すには `variable_selector` を使用する。

```yaml
# YAML 内での変数セレクタ形式
variable_selector:
  - ノードID
  - 出力フィールド名

# 例: start ノードの user_input 変数を参照
variable_selector:
  - start_node_id
  - user_input
```

### 1.2 テンプレート内での変数参照

Answer ノードや LLM プロンプト内では、テンプレート記法で変数を参照する。

```
{{#ノードID.出力フィールド名#}}
```

**使用例**:
```yaml
# Answer ノードで LLM の出力を参照
answer: "{{#llm_node_id.text#}}"

# LLM プロンプトで Start ノードの入力を参照
prompt_template:
  - role: user
    text: "以下の質問に回答してください: {{#start_node_id.user_input#}}"
```

### 1.3 システム変数

チャットフロー（advanced-chat）で利用可能なシステム変数:

| 変数         | 記法                        | 説明                         |
| ------------ | --------------------------- | ---------------------------- |
| ユーザー入力 | `{{#sys.query#}}`           | ユーザーが送信したメッセージ |
| 会話ID       | `{{#sys.conversation_id#}}` | 現在の会話セッションID       |
| ユーザーID   | `{{#sys.user_id#}}`         | ユーザー識別子               |
| ファイル     | `{{#sys.files#}}`           | アップロードされたファイル   |

### 1.4 会話変数

チャットフロー内で会話を跨いで値を保持する変数:

```yaml
workflow:
  conversation_variables:
    - id: "conv-var-uuid"
      name: "history_summary"
      value_type: string
      value: ""
      description: "会話履歴の要約"
```

### 1.5 環境変数

ワークフロー全体で共有される定数:

```yaml
workflow:
  environment_variables:
    - id: "env-var-uuid"
      name: "API_KEY"
      value_type: secret
      value: "encrypted_value"
      description: "外部API認証キー"
```

---

## 2. 各ノードの出力フィールド

### 2.1 Start ノード

| 出力フィールド    | 説明                   |
| ----------------- | ---------------------- |
| `{variable_name}` | 定義した各入力変数の値 |

### 2.2 LLM ノード

| 出力フィールド | 説明               |
| -------------- | ------------------ |
| `text`         | LLM の生成テキスト |
| `usage`        | トークン使用量情報 |

### 2.3 Knowledge Retrieval ノード

| 出力フィールド | 説明                               |
| -------------- | ---------------------------------- |
| `result`       | 検索結果の配列（テキストチャンク） |

### 2.4 Code ノード

| 出力フィールド  | 説明                           |
| --------------- | ------------------------------ |
| `{output_name}` | `outputs` で定義した各出力変数 |

### 2.5 HTTP Request ノード

| 出力フィールド | 説明                 |
| -------------- | -------------------- |
| `body`         | レスポンスボディ     |
| `status_code`  | HTTPステータスコード |
| `headers`      | レスポンスヘッダ     |

### 2.6 Tool ノード

| 出力フィールド | 説明                                 |
| -------------- | ------------------------------------ |
| `text`         | ツールのテキスト出力                 |
| `json`         | ツールのJSON出力（構造はツール依存） |
| `files`        | ツールのファイル出力                 |

### 2.7 IF/ELSE ノード

IF/ELSE ノード自体は出力を持たない。分岐先のノードが処理を継続する。

### 2.8 Question Classifier ノード

分岐先が `sourceHandle` としてクラス ID を使用する。ノード自体の出力はない。

### 2.9 Template Transform ノード

| 出力フィールド | 説明                         |
| -------------- | ---------------------------- |
| `output`       | テンプレート適用後のテキスト |

### 2.10 Variable Aggregator ノード

| 出力フィールド | 説明             |
| -------------- | ---------------- |
| `output`       | 集約された変数値 |

### 2.11 Iteration ノード

| 出力フィールド | 説明           |
| -------------- | -------------- |
| `output`       | 反復結果の配列 |

---

## 3. ノード間接続ルール

### 3.1 基本ルール

| ルール                | 説明                                                                  |
| --------------------- | --------------------------------------------------------------------- |
| Start は1つのみ       | フロー内に Start ノードは必ず1つだけ存在する                          |
| Start は出力のみ      | Start ノードには入力エッジを接続できない                              |
| 終端ノード            | Chatflow は Answer、Workflow は End で終了する                        |
| Answer/End は入力のみ | 終端ノードからの出力エッジは不可                                      |
| 循環禁止              | エッジによる循環参照（ループ）は作成不可（Iteration/Loop 内部を除く） |
| 孤立禁止              | すべてのノードは少なくとも1つのエッジで接続されること                 |

### 3.2 分岐ノードのエッジハンドル

#### IF/ELSE ノード

```yaml
# true 分岐
- source: "ifelse-node-id"
  sourceHandle: "true"
  target: "true-target-node-id"
  targetHandle: "target"

# false 分岐
- source: "ifelse-node-id"
  sourceHandle: "false"
  target: "false-target-node-id"
  targetHandle: "target"
```

#### Question Classifier ノード

```yaml
# 各クラスへの分岐（sourceHandle にクラス ID を使用）
- source: "classifier-node-id"
  sourceHandle: "class-uuid-1"    # classes[].id
  target: "tech-question-node-id"
  targetHandle: "target"

- source: "classifier-node-id"
  sourceHandle: "class-uuid-2"
  target: "biz-question-node-id"
  targetHandle: "target"
```

### 3.3 Iteration ノードの接続

Iteration ノードは内部にサブフローを持つ。内部ノードは `isInIteration: true` フラグと `iteration_id` を持つ。

```yaml
# Iteration ノード自体のエッジ（外部接続）
- source: "前段ノードID"
  sourceHandle: "source"
  target: "iteration-node-id"
  targetHandle: "target"

- source: "iteration-node-id"
  sourceHandle: "source"
  target: "後段ノードID"
  targetHandle: "target"
```

### 3.4 Knowledge Retrieval → LLM 接続

Knowledge Retrieval の結果を LLM のコンテキストとして使用する場合:

```yaml
# LLM ノードの context 設定
data:
  type: llm
  context:
    enabled: true
    variable_selector:
      - knowledge_retrieval_node_id
      - result
```

これにより、LLM は検索結果をコンテキストとして参照し、RAG（Retrieval Augmented Generation）を実現する。

---

## 4. 変数の型

| 型              | 説明             | 使用例                |
| --------------- | ---------------- | --------------------- |
| `string`        | テキスト         | ユーザー入力、LLM出力 |
| `number`        | 数値             | カウント、スコア      |
| `boolean`       | 真偽値           | フラグ、条件判定結果  |
| `object`        | オブジェクト     | JSON構造データ        |
| `array[string]` | 文字列配列       | 検索結果リスト        |
| `array[object]` | オブジェクト配列 | 構造化データリスト    |
| `secret`        | 暗号化文字列     | APIキー等の機密情報   |

---

## 5. 変数マッピングのベストプラクティス

1. **命名規則**: 変数名は snake_case を使用する（例: `user_input`, `search_result`）
2. **型の一致**: 接続元の出力型と接続先の入力型を一致させる
3. **null 安全**: 変数が空の場合のフォールバック処理を考慮する
4. **スコープ**: Iteration 内部の変数は外部から直接参照できない（output_selector 経由）
5. **デバッグ**: Template Transform ノードで変数値を確認用に出力すると便利

```
:::


これを以下のステップで Dify 上に作れば良さそうです。

1. Knowledge Base 作成: 上記4ファイルをアップロード（チャンク1500、Hybrid検索、Rerank有効）
2. Workflow 作成: DSL Generator Engine（Start → KR → LLM設計 → LLM生成 → Code検証 → IF/ELSE → End）
3. Agent 作成: Dify DSL Generator（計画セクション 3.2 のシステムプロンプト + Workflow as Tool）

## 作ったもの

実際に作ったもののスクリーンショットです。
最終的に YAML ファイルが生成されました。ナイスです。

![alt text](/images/05d2ffe846f518/image.png)

![alt text](/images/05d2ffe846f518/image-1.png)

![alt text](/images/05d2ffe846f518/image-2.png)

![alt text](/images/05d2ffe846f518/image-3.png)
