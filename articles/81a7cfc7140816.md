---
title: "EC2 ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ç„¡åŠ¹åŒ–ã¯Terraformä¸€æŠã ã£ãŸã‹ã‚‚ã—ã‚Œãªã„"
emoji: "ğŸ›•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","EC2","Terraform"]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

[AWS ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ æ–™é‡‘ä½“ç³»å¤‰æ›´ã«å¯¾å¿œã™ã‚‹ä½œæ¥­ EC2ç·¨](https://zenn.dev/ryoyoshii/articles/ecef64cde77b2f) ã®å¯¾å¿œã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚  
AWS Backup ã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢ã€AMI ã‹ã‚‰æ‰‹å‹•ã§ãƒªã‚¹ãƒˆã‚¢ãªã©æ–¹æ³•ã¯ã„ãã‚‰ã§ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã§ãƒŸã‚¹ãŒå°‘ãªã„æ–¹æ³•ã‚’æ¨¡ç´¢ã—ã¦ã„ã¾ã™ã€‚  

ä»Šå›ã¯ Terraform ã® import ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ´»ç”¨ã—ã¦ã¿ã¾ã™ã€‚
æ„Ÿå‹•ã«è¿‘ã„ãƒ¬ãƒ™ãƒ«ã§æœ¬ä½œæ¥­ã«æœ€é©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  


## Terraform import ãƒ–ãƒ­ãƒƒã‚¯

import ãƒ–ãƒ­ãƒƒã‚¯ã¯ Terraform 1.5 ã®æ–°æ©Ÿèƒ½ã§ã™ã€‚  
@[card](https://www.hashicorp.com/blog/terraform-1-5-brings-config-driven-import-and-checks)  
 
1.5ã‚ˆã‚Šä»¥å‰ã‹ã‚‰ import æ©Ÿèƒ½ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚import ãƒ–ãƒ­ãƒƒã‚¯ã«ãªã£ã¦ä½•ãŒå¬‰ã—ã„ã‹ã¨ã„ã†ã¨ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã® TF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãã‚Œã¾ã™ã€‚
1.5ã‚ˆã‚Šä»¥å‰ã¯äºˆã‚ãƒªã‚½ãƒ¼ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾©ã—ã¦ãŠã„ã¦ import ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã—ã¦ã„ãŸã®ã§ã€æ‰‹é–“ãŒåœ§å€’çš„ã«é•ã„ã¾ã™ã€‚  

## ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã¿ã‚‹

æ—¢å­˜ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã¿ã¾ã™ã€‚  

ã©ã†ã›ãªã®ã§æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚  

```bash
$ terraform --version
Terraform v1.5.4
```

Provider.tf ã‚’ç°¡å˜ã«æ›¸ãã¾ã™ã€‚  

```tcl:Provider.tf
terraform {
  required_version = ">= 1.5.4"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.6.2"
    }
  }

  backend "s3" {
    bucket  = "your-bucket-name"
    region  = "your-region"
    key     = "import-test/terraform.tfstate"
    encrypt = true
  }
}

// Configure the AWS Provider
provider "aws" {
  region  = "your-region"
}
```

ä»Šå› import ãƒ–ãƒ­ãƒƒã‚¯ã¯ import.tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã—ãŸã€‚  
`id` ã« AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’ `to` ã« Terraform ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚  

```tcl:import.tf
import {
  id = "your-instance-id"
  to = aws_instance.source
}
```

`terraform init`ã€`terraform plan` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  
`plan` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ `-generate-config-out=generated.tf` ã¯å‡ºåŠ›å…ˆã® TF ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚  

```bash
$ terraform init
$ terraform plan -generate-config-out=generated.tf
```

## ç”Ÿæˆã•ã‚ŒãŸTFãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

`-generate-config-out=generated.tf` ã§ç”Ÿæˆã•ã‚ŒãŸ TF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å°‘ã—ç·¨é›†ã—ã¾ã™ã€‚  
ç·¨é›†ç®‡æ‰€ã¯ä»¥ä¸‹ã§ã™ã€‚  

```tcl:generated.tf
  // ipv6_address_count ã¨å…±å­˜ã§ããªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  #ipv6_addresses                       = []

  // æœ€çµ‚è¡Œã«è¿½è¨˜
  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’èª¤ã£ã¦æ“ä½œã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ãŠã¾ã˜ãªã„
  lifecycle {
    ignore_changes = all
  }
```

## Stateã¸åæ˜ 

import ãƒ–ãƒ­ãƒƒã‚¯ã«æ›¸ã„ã¦ `terraform plan` ã—ãŸã ã‘ã§ã¯ State ã¸åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚  
`terraform apply` ã§ State ã¸åæ˜ ã—ã¾ã™ã€‚  

```bash
$ terraform apply
ã€œç•¥ã€œ
aws_instance.source: Importing... [id=i-xxxx]
aws_instance.source: Import complete [id=i-xxxx]
aws_instance.source: Modifying... [id=i-xxxx]
aws_instance.source: Modifications complete after 3s [id=i-xxxx]

Apply complete! Resources: 1 imported, 0 added, 1 changed, 0 destroyed.
```

## AMI ä½œæˆ

ã“ã®å¾Œã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¤‡è£½ã™ã‚‹ã®ã§ AMI ã‚’å–å¾—ã—ã¾ã™ã€‚  
é›£ã—ã„ã“ã¨ã¯ãªãã‚µã‚¯ãƒƒã¨å–å¾—ã—ã¦ã—ã¾ã£ã¦ãã ã•ã„ã€‚  

## ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç„¡åŠ¹ã«ã—ã¦è¤‡è£½

ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç„¡åŠ¹ã«ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¤‡è£½ã—ã¾ã™ã€‚  
generated.tf ã‚’åˆ¥åã§ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚ä»Šå›ã¯ `ec2.tf` ã«ã—ã¾ã—ãŸã€‚  
`ec2.tf` ã‚’è¤‡è£½ç”¨ã«ç·¨é›†ã—ã¾ã™ã€‚ç·¨é›†ç®‡æ‰€ã ã‘æŠœç²‹ã—ã¾ã™ã€‚  

```tcl:ec2.tf
// ãƒªã‚½ãƒ¼ã‚¹å
resource "aws_instance" "new" {
  ami                                  = "ami-0fe4255d7b73c35a9"    // å‰ã®æ‰‹é †ã§å–å¾—ã—ãŸ AMI
  associate_public_ip_address          = false                      // ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ç„¡åŠ¹
  private_ip                           = "10.0.4.100"               // ç¾å­˜ã™ã‚‹å…¨ AWS ãƒªã‚½ãƒ¼ã‚¹ã¨é‡è¤‡ã—ãªã„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€è¡Œå‰Šé™¤ã§ã‚‚ã„ã„
}
```

ç·¨é›†å†…å®¹ã‚’ã‚ˆãç¢ºèªã—ã¾ã™ã€‚èª¤ã£ã¦æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã«å½±éŸ¿ã‚’å‡ºã•ãªã„ã‚ˆã†ã«æ°—ã‚’ã¤ã‘ã¾ã™ã€‚  
`terraform plan` ã§ã‚‚åŒæ§˜ã«æ…é‡ãªãƒã‚§ãƒƒã‚¯ã‚’å¿˜ã‚Œãšã«ã€‚  

```bash
$ terraform plan

$ terraform apply
```

ã—ã°ã‚‰ãã™ã‚‹ã¨è¤‡è£½ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã—ã¾ã™ã€‚  
é©šãã»ã©ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚  

## ã¾ã¨ã‚

Terraform ã®æ–°æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚  
ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®èª²é‡‘è‡ªä½“ã¯ãã“ã¾ã§ç¥çµŒè³ªã«ãªã‚‹ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå¤šã™ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã¯æ‰‹å½“ã¦ã¯å¿…è¦ã ã¨æ€ã„ã¾ã™ã€‚  



