---
title: "Grafanaã§ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["grafana", "tempo", "servicegraph", "servicemap"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®é‹ç”¨ã®æ‚©ã¿ã©ã“ã‚ã¯ã€Œã©ã“ã§ä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹æŠŠæ¡ã—ã«ãã„ã€ã¨ã„ã†æ–¹ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ã€‚  
ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—ï¼‰ã¯ã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®é–¢ä¿‚æ€§ã‚’è¦–è¦šåŒ–ã™ã‚‹ãŸã‚ã®æœ‰åŠ¹ãªæ‰‹æ®µã§ã™ã€‚  

Grafana ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚  

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### kubectl ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ“ä½œã™ã‚‹ãŸã‚ã« kubectl ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  

[Install Tools](https://kubernetes.io/docs/tasks/tools/) ã« OS ã”ã¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã‚Œã‚’å‚ç…§ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚  

### minikube ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»Šå›ã¯ minikube ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚  
minikube ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’èµ·å‹•ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã¯ [minikube start](https://minikube.sigs.k8s.io/docs/start/) ã‚’å‚ç…§ãã ã•ã„ã€‚  

```bash
$ brew install minikube

# help ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
$ minikube --help
minikube ã¯ã€é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”¨ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ« Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ãƒ»ç®¡ç†ã—ã¾ã™ã€‚
ã€œã€œçœç•¥ã€œã€œ
```

minikube ã‚’èµ·å‹•ã™ã‚‹ã®ã§ã™ãŒã€ãƒ‡ãƒ¢ã®å‹•ä½œç’°å¢ƒãƒ¡ãƒ¢ãƒªãŒã€Œ6 GB of free RAM for the applicationã€ãªã®ã§ã€minikube èµ·å‹•æ™‚ã«ãƒ¡ãƒ¢ãƒªå®¹é‡ã‚’ 6GB ä»¥ä¸Šã«æŒ‡å®šã—ã¾ã™ã€‚  

```bash
$ minikube start --cpus='4' --memory='8G'
```

### Helm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Helm ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://helm.sh/ja/docs/intro/install/) ã‚’å‚ç…§ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚  
é›£ã—ããªã„ã§ã™ã€‚Mac ãªã‚‰ brew ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚  

```bash
$ brew install helm
```
### OpenTelemetry Demo Helm Chart ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

ä»Šå›ã¯ OpenTelemetry ã®ãƒ‡ãƒ¢ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Helm Chart ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚  

```bash
$ helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
$ helm repo update
$ helm pull open-telemetry/opentelemetry-demo
$ tar -zxf opentelemetry-demo-0.30.2.tgz
```

TAR Ball ã‚’å±•é–‹ã™ã‚‹ã¨ã€`opentelemetry-demo` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™ã€‚  

### Tempo Helm Chart ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€Grafana ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã® Tempo ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚  
Tempo ã® Helm Chart ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚  
`opentelemetry-demo/charts/` ã«å±•é–‹ã—ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ helm pullã€å±•é–‹ã®é †ã«å®Ÿæ–½ã—ã¾ã™ã€‚  

```bash
$ cd opentelemetry-demo/charts/
$ helm repo add grafana https://grafana.github.io/helm-charts
$ helm repo update
$ helm pull grafana/tempo-distributed
$ tar -xzf tempo-distributed-1.9.4.tgz 
```

### Chart.yamk ã« Tempo ã‚’è¿½è¨˜

`opentelemetry-demo/Chart.yaml` ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚  

```yaml:opentelemetry-demo/Chart.yaml
apiVersion: v2
appVersion: 1.9.0
dependencies:
ï¼ˆçœç•¥ï¼‰
# dependencies ãƒ–ãƒ­ãƒƒã‚¯ã«ä»¥ä¸‹ã®4è¡Œã‚’è¿½è¨˜
- condition: tempo.enabled
  name: tempo-distributed
  repository: https://grafana.github.io/helm-charts
  version: 1.9.4
ï¼ˆçœç•¥ï¼‰
```

### values.schema.json ã« Tempo ã®ã‚¹ã‚­ãƒ¼ãƒã‚’è¿½è¨˜

`opentelemetry-demo/values.schema.json` ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚  

```yaml:opentelemetry-demo/values.schema.json
ï¼ˆçœç•¥ï¼‰
    "opensearch": {
      "type": "object"
    },    # â† ã‚»ãƒŸã‚³ãƒ­ãƒ³ã‚’è¿½åŠ 
    # opensearch ã®ä¸‹ã«ä»¥ä¸‹3è¡Œã‚’è¿½è¨˜
    "tempo-distributed": {
      "type": "object"
    }
ï¼ˆçœç•¥ï¼‰
```

### Tempo ã®è¨­å®š

`opentelemetry-demo/values.yaml` ã®æœ«ã« Tempo ã‚’è¿½è¨˜ã—ã¾ã™ã€‚  
ã“ã“ã§æ³¨ç›®ã—ã¦ã»ã—ã„ã®ã¯ **metricsGenerator** ã§ã™ã€‚  

metricsGenerator ã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚  
åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®é–¢ä¿‚æ€§ã‚’ç¤ºã™ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆã™ã‚‹ `service-graphs`ã€RED (Request, Error and Duration) ã‚’ç”Ÿæˆã™ã‚‹ `span-metrics`ã€é«˜åº¦ãªè¨ˆç®—ã®ãŸã‚ã‚¹ãƒ‘ãƒ³ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹ `local-blocks` ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚  

```yaml:opentelemetry-demo/values.yaml
tempo-distributed:
  enabled: true
  traces:
    otlp:
      grpc:
        enabled: true
  compactor:
    compaction:
      block_retention: 8h        # Optional. Duration to keep blocks.  Default is 14 days (336h).
  storage:
    trace:
      backend: local        # ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ã®ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã«è¨­å®š
      wal:
        path: /var/tempo/wal
      local:
        path: /var/tempo/blocks
  metricsGenerator:
    enabled: true
    persistence:
      enabled: true
    config:
      storage:
        remote_write:        # ã‚¹ãƒ‘ãƒ³ã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç”Ÿæˆã—ã¦ Prometheus ã«é€ä¿¡ã™ã‚‹è¨­å®š
          - url: http://my-otel-demo-prometheus-server:9090/api/v1/write
            send_exemplars: true
  global_overrides:
    metrics_generator_processors:         # metricsGenerator ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã®è¨­å®š
      - "service-graphs"
      - "span-metrics"
      - "local-blocks"
  resources:
    limits:
      memory: 150Mi
```

### OpenTelemetry Collector ã®è¨­å®š

`opentelemetry-demo/values.yaml` ã® `opentelemetry-collector` ãƒ–ãƒ­ãƒƒã‚¯ã« Tempo å‘ã‘ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚  
OpenTelemetry Demo ã§ã¯ Jaegar ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ãŒã€Tempo ã«é€ä¿¡ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚  

```yaml:opentelemetry-demo/values.yaml
opentelemetry-collector:
ï¼ˆçœç•¥ï¼‰
    exporters:
ï¼ˆçœç•¥ï¼‰
      # exporter ã«ä»¥ä¸‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½è¨˜
      otlp/tempo:
        endpoint: '{{ include "otel-demo.name" . }}-tempo-distributor:4317'
        tls:
          insecure: true
ï¼ˆçœç•¥ï¼‰
    service:
      pipelines:
        traces:
          processors: [memory_limiter, resource, batch]
          exporters: [otlp/tempo, debug]    # traces ã® exporters ã‚’ otlp/tempo ã«å‘ã‘ã‚‹
ï¼ˆçœç•¥ï¼‰
```

### Prometheus ã®è¨­å®š

`opentelemetry-demo/values.yaml` ã® `prometheus` ãƒ–ãƒ­ãƒƒã‚¯ã« Remote Write Receiver è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚  
Tempo ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«å¤‰æ›ã—ã¾ã™ã€‚ãã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus ã«é€ä¿¡ã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚  

```yaml:opentelemetry-demo/values.yaml
prometheus:
ï¼ˆçœç•¥ï¼‰
  server:
    extraFlags:
      - "enable-feature=exemplar-storage"
      - "enable-feature=otlp-write-receiver"
      - "web.enable-remote-write-receiver"        # ã“ã®è¡Œã‚’è¿½è¨˜ã€Tempo ã‹ã‚‰ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å—ã‘å–ã‚‹ãŸã‚ã®è¨­å®š
ï¼ˆçœç•¥ï¼‰
```


### Grafana ã®è¨­å®š

`opentelemetry-demo/values.yaml` ã® `grafana` ãƒ–ãƒ­ãƒƒã‚¯ã« Tempo ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚  
ã“ã“ãŒæœ¬ã‚¨ãƒ³ãƒˆãƒªã®æœ¬é¡Œã§ã™ã€‚Grafana ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚  

```yaml:opentelemetry-demo/values.yaml
grafana:
ï¼ˆçœç•¥ï¼‰
        - name: Tempo
          type: tempo
          uid: tempo
          url: 'http://{{ include "otel-demo.name" . }}-tempo-query-frontend:3100'
          access: proxy
          editable: true
          isDefault: false
          jsonData:
            httpMethod: GET
            serviceMap:
              datasourceUid: 'webstore-metrics'
ï¼ˆçœç•¥ï¼‰
```

## ãƒ‡ãƒ¢èµ·å‹•

å¤‰æ›´ã—ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ãŸ chart ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¢ã‚’èµ·å‹•ã—ã¾ã™ã€‚  

```bash
$ helm install my-otel-demo ./opentelemetry-demo -n otel-demo --create-namespace
NAME: my-otel-demo
LAST DEPLOYED: 
NAMESPACE: otel-demo
STATUS: deployed
REVISION: 1
NOTES:
=======================================================================================


 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
 â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â•


- All services are available via the Frontend proxy: http://localhost:8080
  by running these commands:
     kubectl --namespace otel-demo port-forward svc/my-otel-demo-frontendproxy 8080:8080

  The following services are available at these paths once the proxy is exposed:
  Webstore             http://localhost:8080/
  Grafana              http://localhost:8080/grafana/
  Load Generator UI    http://localhost:8080/loadgen/
  Jaeger UI            http://localhost:8080/jaeger/ui/


# æ­£å¸¸èµ·å‹•ç¢ºèªã€æ•°åˆ†ã‹ã‹ã‚Šã¾ã™
$ kubectl get pod -n otel-demo
```

å‡ºåŠ›ã§ç¤ºã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  
`http://localhost:8080/grafana/` ã§ Grafana ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚  

```bash
$ kubectl --namespace otel-demo port-forward svc/my-otel-demo-frontendproxy 8080:8080
```

Grafana ã‹ã‚‰ Explore â†’ Tempo â†’ Service Graph ã‚’é¸æŠã™ã‚‹ã¨ã€RED (Request, Error and Duration) ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚  

![alt text](/images/grafana_tempo_servicegraph.png)

## å‚è€ƒ

[Get started with Grafana Tempo using the Helm chart](https://grafana.com/docs/helm-charts/tempo-distributed/next/get-started-helm-charts/)  
[Configure Tempo](https://grafana.com/docs/tempo/latest/configuration/)  
[Metrics-generator](https://grafana.com/docs/tempo/latest/metrics-generator/)  

