---
title: "AWS Distro for OpenTelemetryãŒãƒ­ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸã®ã§åé›†ã—ã¦ã¿ãŸ"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","ADOT","OpenTelemetry"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

AWS Distro for OpenTelemetry (ADOT) ãŒãƒ­ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚  
ADOT Collector ã¾ãŸã¯ OpenTelemetry SDK (Java, Java Script, .NET, Python) ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’åé›†ã—ã€OTLP ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸è»¢é€ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚  

Fluent Bit ãŒã‚ã‚‹ã‹ã‚‰ã„ã„ã‚„ã€ã¨æ€ã†äººãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã¾ãã¾ããã†è¨€ã‚ãšã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚  
ãƒˆãƒ¬ãƒ¼ã‚¹ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ ADOT Collector ã‚„ OTEL SDK ã‚’ä½¿ã£ã¦åé›†ã—ã¦ã„ã‚‹ãªã‚‰ã€ãƒ­ã‚°ã‚‚ä¸€ç·’ã«ã©ã†ã§ã—ã‚‡ã†ã‹ã¨ã„ã†è€ƒãˆã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚  

ã¾ãŸã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ä»˜ä¸ã—ã¦ã„ã‚‹ OTEL ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«ã‚‚ä»˜ä¸ã§ãã‚Œã°ã€ãã‚Œãã‚Œã®ç´ä»˜ã‘ãŒã§ãã€è§£æã«å½¹ç«‹ã¤å¯èƒ½æ€§ã¯ã‚ã‚Šã¾ã™ã€‚  

@[card](https://aws.amazon.com/jp/about-aws/whats-new/2023/11/logs-support-aws-distro-opentelemetry/)  


ãŸã ã€Stability ã¯ beta ã¨ãªã£ã¦ã„ã¾ã™ã€‚Breaking Changes ã¯ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã”ç•™æ„ãã ã•ã„ã€‚  
[AWS CloudWatch Logs Exporter](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awscloudwatchlogsexporter)  


## ã‚„ã£ã¦ã¿ãŸ

ECS ã«ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã¨ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ (ADOT Collector) ã‚’ç«‹ã¦ã¦ `/var/log/logFile.log` ã«åãå‡ºã—ãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ CloudWatch Logs ã«è»¢é€ã—ã¾ã™ã€‚
CloudWatch Logs ãŒä¸€ç•ªãŠæ‰‹è»½ãªã®ã§ãã†ã—ã¦ã„ã¾ã™ãŒã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ OTLP ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚Œã° OK ã§ã™ã€‚(CloudWatch Logs ã«è»¢é€ã™ã‚‹æ„å‘³ã¯ã‚ã¾ã‚Šç„¡ã„ã§ã™ãŒã€ãã†ã„ã†ãƒ„ãƒƒã‚³ãƒŸã¯ãªã—ã§)  

![img](/images/adot_log_support.drawio.png)  

### ECS

ä»Šå›ã¯ ECS on Fargate ã§è©¦ã—ã¾ã™ã€‚  

ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚å¿…è¦ãªç®‡æ‰€ã ã‘æ›¸ã„ã¦ã„ã¾ã™ã€‚çœç•¥ã—ãŸé …ç›®ã¯ã‚ˆã—ãªã«è¨­å®šã—ã¦ãã ã•ã„ã€‚  
ãƒã‚¤ãƒ³ãƒˆã¯ã€`volumes` ã§ã‚¿ã‚¹ã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å®šç¾©ã—ã€2ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠã§åŒã˜ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¦‹ã›ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªãŒå‡ºåŠ›ã—ãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ OTEL Collector ãŒèª­ã‚ã‚‹ã‚ˆã†ã«ã“ã†ã—ã¦ã„ã¾ã™ã€‚  

```json
{
    "containerDefinitions": [
        {
            "name": "aws-otel-collector",
            "image": "public.ecr.aws/aws-observability/aws-otel-collector:v0.35.0",
            "mountPoints": [
                {
                    "sourceVolume": "varlog",
                    "containerPath": "/var/log"
                }
            ],
            "secrets": [
                {
                    "name": "AOT_CONFIG_CONTENT",
                    "valueFrom": "adotconfig"
                }
            ]
        },
        {
            "name": "your_app",
            "image": "your_image:tag",
            "mountPoints": [
                {
                    "sourceVolume": "varlog",
                    "containerPath": "/var/log"
                }
            ]
        }
    ],
    "volumes": [
        {
            "name": "varlog",
            "host": {}
        }
    ]
}
```

### SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ã¯ ADOT Collector ã® Config ã‚’æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚  
Filelog receiver ã§ `/var/log/*.log` ã‚’æ‹¾ã£ã¦ã„ã¾ã™ã€‚  
[AWS CloudWatch Logs Exporter](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awscloudwatchlogsexporter) ã§ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ç­‰ã®æŒ‡å®šã‚’ã—ã¦ã„ã¾ã™ã€‚  


```yml
receivers:
  filelog:
    include: [ /var/log/*.log ]

processors:
  batch:

  memory_limiter:
    limit_mib: 100
    check_interval: 5s


exporters:
  awscloudwatchlogs:
    log_group_name: "/ecs/your_app"
    log_stream_name: "logfile"
    region: "us-west-2"
    log_retention: 7

service:
  pipelines:
    logs:
      receivers: [filelog]
      processors: [memory_limiter,batch]
      exporters: [awscloudwatchlogs]
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°

ã‚ã¨ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ `/var/log/` ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¦ã‚ã’ã‚Œã° OK ã§ã™ã€‚  
ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã—ã¾ã™ã€‚  

## ã¾ã¨ã‚

ADOT ã®ãƒ­ã‚°ã‚µãƒãƒ¼ãƒˆã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚  
ä»–ã®ä»•çµ„ã¿ã§ãƒ­ã‚°è»¢é€ã¯å®Ÿç¾ã§ãã¦ã„ãŸã‹ã¨æ€ã„ã¾ã™ãŒã€ADOT Collector ã ã‘ã§åŸºæœ¬3ç¨®ã€ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã¯å¬‰ã—ã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚  


## å‚è€ƒ

[Container Logs Collector Configuration](https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/config-container-logs#collector-configuration-for-otlp-ingest)  
[AWS CloudWatch Logs Exporter](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awscloudwatchlogsexporter)  
[ãƒã‚¤ãƒ³ãƒ‰ãƒã‚¦ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/bind-mounts.html)  


