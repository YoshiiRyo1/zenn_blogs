---
title: "ECS ã§å°ã•ãå§‹ã‚ã‚‹ OpenTelemetry æ§‹æˆ"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["opentelemetry", "grafana", "aws", "ecs"]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

ãªã«ã”ã¨ã‚‚å°ã•ãå§‹ã‚ã¦æˆåŠŸä½“é¨“ã‚’ç©ã¿ä¸Šã’ãªãŒã‚‰å¤§ããã—ã¦ã„ãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚  
Observability ã«ã¤ã„ã¦ã‚‚åŒã˜è€ƒãˆã§ã™ã€‚  

ã“ã‚Œã‹ã‚‰ Observability ã‚’å°å…¥ã™ã‚‹æ–¹ã®åŠ©ã‘ã«ãªã‚Œã°ã¨æ€ã„ã€ECS ã§å°ã•ãå§‹ã‚ã‚‹ OpenTelemetry æ§‹æˆã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚  

:::message
2024/08/15 æ›´æ–°: ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
:::

## æ§‹æˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« OpenTelemetry SDK ã‚’çµ„ã¿è¾¼ã¿ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ OpenTelemetry Collector ã«é€ä¿¡ã—ã¾ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã¯ CloudWatch Logs ã«é€ä¿¡ã—ã¾ã™ã€‚  

OpenTelemetry Collector ã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’é¸æŠè‚¢ã—ã¾ã—ãŸã€‚  
OpenTelemetry Collector ã¯ Tempo ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’é€ä¿¡ã—ã€Prometheus ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã€‚  

Prometheus ã¯ Mimir ã‚’çµŒç”±ã—ã¦å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ S3 ã«ä¿å­˜ã—ã¾ã™ã€‚  

å¯è¦–åŒ–ã¯ Grafana ã§è¡Œã„ã¾ã™ã€‚  

å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ ECS on Fargate ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚  

![img](/images/0552d3c8dcca6a.drawio.png)


## OpenTelemetry Collector

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã”ã¨ã«è¨­å®šã‚’è§£èª¬ã—ã¾ã™ã€‚  

receiver ã¯ otlp ã¨ prometheus ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã« Prometheus Library ã‚’è¨ˆè£…ã—ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ OpenTelemetry Collector ãŒã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚  

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ã«ãƒ¡ã‚¿æƒ…å ±ã‚’ä»˜ä¸ã—ãŸã„ã®ã§ resourcedetection ã¨ resource ã§ ECS ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚ã¨ã¯ã„ãˆã€å…¨ã¦ã¯è¦ã‚‰ãªã„ã®ã§é¸æŠã—ã¦ã„ã¾ã™ã€‚  

exporters ã«ã¯ Tempo ã¨ Prometheus ã«é€ä¿¡ã™ã‚‹è¨­å®šã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: localhost:4317

  prometheus:
    config:
      scrape_configs:
        - job_name: 'prometheus-library'
          metrics_path: '/metrics'
          scrape_interval: 15s
          scrape_timeout: 10s
          static_configs:
            - targets: ['localhost:8080']

extensions:
  health_check: {}

processors:
  batch: {}

  memory_limiter:
    check_interval: 5s
    limit_percentage: 80
    spike_limit_percentage: 25

  resourcedetection:
    detectors: 
      - env
      - ecs

  resource:
    attributes:
      - key: net_host_port
        action: delete
      - key: server_port
        action: delete
      - key: service_instance_id
        action: delete
      - key: http_scheme
        action: delete
      - key: url_scheme
        action: delete
      - key: cloud.provider
        action: delete
      - key: cloud.account.id
        action: delete
      - key: cloud.platform
        action: delete
      - key: cloud.region
        action: delete
      - key: cloud.availability_zone
        action: delete
      - key: aws.ecs.task.arn
        action: delete
      - key: aws.ecs.task.family
        action: delete
      - key: TaskDefinitionRevision
        from_attribute: aws.ecs.task.revision
        action: insert
      - key: aws.ecs.task.revision
        action: delete
      - key: aws.ecs.launchtype
        action: delete
      - key: aws.ecs.cluster.arn
        action: delete
      - key: aws.log.group.names
        action: delete
      - key: aws.log.group.arns
        action: delete
      - key: aws.log.stream.names
        action: delete
      - key: aws.log.stream.arns
        action: delete

exporters:
  debug:

  otlp/tempo:
    endpoint: tempo.my-local-domain:4317
    tls:
      insecure: true

  prometheusremotewrite:
    endpoint: "http://prometheus.my-local-domain:9090/api/v1/write"
    resource_to_telemetry_conversion:
      enabled: true

service:
  extensions:
    - health_check

  pipelines:
    traces:
      receivers:
        - otlp
      processors: 
        - resourcedetection
        - resource
        - memory_limiter
        - batch
      exporters: 
        - otlp/tempo
        - debug
    metrics:
      receivers: 
        - otlp
        - prometheus
      processors: 
        - resourcedetection
        - resource
        - memory_limiter
        - batch
      exporters: 
        - prometheusremotewrite
        - debug
```
::::

## Prometheus

Prometheus ã¯ç‰¹ã«ãªã«ã‚‚è¨­å®šã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚Mimir ã®é€ä¿¡å…ˆã®ã¿ã§ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
remote_write:
  - url: http://mimir.my-local-domain:8080/api/v1/push
```
::::

## Tempo

Tempo ã¯ All In One å‹ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãŒä¸­è¦æ¨¡ä»¥ä¸Šã«ãªã£ã¦ãã‚‹ã‚ˆã†ãªã‚‰ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å‹ã®æ§‹æˆã‚’æ¤œè¨ã™ã‚‹ã¤ã‚‚ã‚Šã§ã™ã€‚  

[metrics_generator](https://grafana.com/docs/tempo/latest/metrics-generator/) ã¯ä»Šå›ã©ã†ã—ã¦ã‚‚å°å…¥ã—ãŸã‹ã£ãŸæ©Ÿèƒ½ã§ã™ã€‚  
ãƒˆãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚  
overrides ã§æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã¾ã™ã€‚  

storage ã¯ S3 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚  

compactor ã§ 720 æ™‚é–“ä»¥ä¸Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹è¨­å®šã‚’ã—ã¦ã„ã¾ã™ã€‚ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ­ã‚°ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é–¢é€£ä»˜ã‘ã¦ã„ã‚‹å ´åˆã¯æœŸé–“ã‚’åˆã‚ã›ã¦è¨­å®šã—ã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
distributor:
  receivers:
    otlp:
      protocols:
        grpc: 
          endpoint: 0.0.0.0:4317

ingester:
  flush_all_on_shutdown: true

server:
  http_listen_port: 8080

metrics_generator:
  storage:
    remote_write:
      - url: http://prometheus.my-local-domain:9090/api/v1/write
        send_exemplars: true
    path: /var/tempo/generator/wal

compactor:
  compaction:
    block_retention: 720h

storage:
  trace:
    backend: s3
    wal:
      path: /var/tempo/wal 
    s3:
      bucket: My_Bucket_Name
      endpoint: s3.ap-northeast-1.amazonaws.com
      region: ap-northeast-1

overrides:
  defaults:
    metrics_generator:
     processors: ["service-graphs", "span-metrics"]
```
::::

## Mimir

storage ã¯ S3 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚Tempo ã¨ã¯ãã‚Œãã‚Œåˆ¥ã®ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚  
ã‚ã¨ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé€šã‚Šã§ã€ç‰¹ã«ã“ã‚Œã¨ã„ã£ãŸè¨­å®šã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```yaml
target: all

activity_tracker:
  filepath: "/data/metrics-activity.log"

common:
  storage:
    backend: s3
    s3:
      bucket_name: My_Bucket_Name
      endpoint: s3.ap-northeast-1.amazonaws.com
      region: ap-northeast-1

ruler:
  rule_path: /data/data-ruler/

ruler_storage:
  storage_prefix: ruler

alertmanager:
  sharding_ring:
    replication_factor: 1

alertmanager_storage:
  storage_prefix: alertmanager

blocks_storage:
  storage_prefix: blocks
  bucket_store:
    sync_dir: /data/tsdb-sync/
  tsdb:
    dir: /data/tsdb/

compactor:
  data_dir: /data/data-compactor/

limits:
  compactor_blocks_retention_period: 30d

store_gateway:
  sharding_ring:
    replication_factor: 1

ingester:
  ring:
    replication_factor: 1
```
::::

## ECS ã‚¿ã‚¹ã‚¯å®šç¾©

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¿ã‚¹ã‚¯å®šç¾©ã§ã™ã€‚ã‹ãªã‚ŠæŠœç²‹ã—ã¦ã„ã¾ã™ã€‚  

OTEL_EXPORTER_OTLP_ENDPOINT ã¯ `"http://localhost:4317"` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã® OpenTelemetry Collector å®›ã§ã™ã€‚
ECS ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¯ localhost ã§ã™ã€‚Docker Compose ã«æ…£ã‚Œã¦ã„ã‚‹ã¨æœ€åˆã¯é•å’Œæ„ŸãŒã‚ã‚Šã¾ã™ã€‚  

::::details ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
```json
    "containerDefinitions": [
        {
            "name": "app",
            "image": "my_image",
            "portMappings": [
                {
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "environment": [
                {
                    "name": "OTEL_EXPORTER_OTLP_ENDPOINT",
                    "value": "http://localhost:4317"
                },
                {
                    "name": "OTEL_RESOURCE_ATTRIBUTES",
                    "value": "service.name=app"
                },
            ],
        },
        {
            "name": "otel",
            "image": "my_otel_col_image",
            "portMappings": [
                {
                    "name": "otel-4317-tcp",
                    "containerPort": 4317,
                    "hostPort": 4317,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "command": [
                "--config=/etc/otel-config.yaml"
            ],
            "environment": [
                {
                    "name": "OTEL_RESOURCE_ATTRIBUTES",
                    "value": "service.name=app"
                }
            ],
        }
    ],
```
::::

## å®¿é¡Œ

ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ­ã‚°ã®é–¢é€£ä»˜ã‘ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚  
CloudWatch Logs ã«ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ã‚’ä¿å­˜ã—ã¦ã„ã‚‹ã¨ã“ã‚ã®ãƒ„ãƒ©ãƒŸãŒå°‘ã€…ã‚ã‚Šã¾ã—ã¦ã€‚ã€‚ã€‚  
Loki ã‚’è¿½åŠ ã—ã¦ Loki ã«ãƒ­ã‚°ã‚’é€ã‚‹ã¨å€‹äººçš„ã«ã¯æ¥½ã«ãªã‚‹ã¨æ€ã£ã¦ã„ã¾ã™ãŒã€è‡ªåˆ†ã ã‘ãŒãƒ­ã‚°ã‚’è¦‹ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ãƒãƒ©ãƒ³ã‚¹ãŒå¿…è¦ã§ã™ã€‚  

