---
title: "OpenTelemetry ã§PHP ã®è¦³æ¸¬ã«æŒ‘æˆ¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OpenTelemetry", "php"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

PHP ã§ä½œæˆã•ã‚ŒãŸã‚µã‚¤ãƒˆé‹å–¶ã«å°‘ã—ã ã‘é–¢ã‚ã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§ã€OpenTelemetry ã‚’ç”¨ã„ãŸ Observability ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚  
æ§‹æˆã¯ä»¥ä¸‹ã«ãªã£ã¦ã„ã¾ã™ã€‚OpenTelemetry Collectorã€Tempoã€Promtailã€Lokiã€Grafana ã§æ§‹æˆã—ã¾ã—ãŸã€‚  
![img](/images/816a01fd8b07df.drawio.png)


## OpenTelemetry ã¨ PHP

@[card](https://opentelemetry.io/docs/languages/php/)  

OpenTelemetry PHP ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ Tracesã€Metricsã€Logs ã¨ã‚‚ã« Stable ã¨ãªã£ã¦ã„ã¾ã™ã€‚  
è‡ªå‹•è¨ˆè£…ç”¨ã® Extension ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦æœ€ä½é™ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã®ã¯å¬‰ã—ã„ã“ã¨ã§ã™ã€‚  


## ã‚„ã£ã¦ã¿ãŸ

ä»Šå›ã¯ minikube ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§æ§‹ç¯‰ã—ã¾ã—ãŸã€‚[ã“ã¡ã‚‰](https://github.com/YoshiiRyo1/zenn_blogs/tree/main/sources/php-o11y)ã§ yaml ç­‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚  

### ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒª

ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã¯ [OpenTelemetry](https://opentelemetry.io/docs/languages/php/instrumentation/) ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ãã®ã¾ã¾ã¤ã‹ã„ã¾ã—ãŸã€‚  

ã“ã¡ã‚‰ãŒ Dockerfile ã§ã™ã€‚ä¾å­˜é–¢ä¿‚ã‚„ SDK ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚å°‘ã€…éå‰°ãªæ°—ãŒã—ãªãŒã‚‰ã‚‚è¿½åŠ è¿½åŠ ã—ã¦ã„ãŸã‚‰ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  

https://github.com/YoshiiRyo1/zenn_blogs/blob/main/sources/php-o11y/docker/php-fpm/Dockerfile

ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã« OpenTelemetry ã®ã„ã¤ã‚‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¶³ã—ã¦ã‚ã’ã‚Œã° OK ã§ã™ã€‚è‡ªå‹•è¨ˆè£…ã¯ä¾¿åˆ©ã§ã™ã­ã€‚  

```yaml
        env:
        - name: OTEL_PHP_AUTOLOAD_ENABLED
          value: "true"
        - name: OTEL_SERVICE_NAME
          value: "php-demo"
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_METRICS_EXPORTER
          value: "none"
        - name: OTEL_LOGS_EXPORTER
          value: "console"
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          value: "grpc"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://opentelemetry-collector:4317"
        - name: OTEL_PROPAGATORS
          value: "baggage,tracecontext"
```


### OpenTelemetry Collector

Collector ã®ä¸»ã ã£ãŸè¨­å®šã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãªã‚“ã®å¤‰å“²ã‚‚ç„¡ã„ã§ã™ç¬‘

```yaml
  exporters:
    debug: {}
    otlp:
      endpoint: tempo:4317
      tls:
        insecure: true
  extensions:
    health_check: {}
    memory_ballast: {}
  processors:
    batch: {}
    memory_limiter:
      check_interval: 5s
      limit_percentage: 80
      spike_limit_percentage: 25
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: ${env:MY_POD_IP}:4317
        http:
          endpoint: ${env:MY_POD_IP}:4318
  service:
    extensions:
      - health_check
      - memory_ballast
    pipelines:
      traces:
        exporters:
          - debug
          - otlp
        processors:
          - memory_limiter
          - batch
        receivers:
          - otlp
```

### Promtail

OpenTelemetry Log ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼ï¼ˆStdErrï¼‰ã«å‡ºã—ãã‚Œã‚’ Promtail ã§åé›†ã—ã¦ã„ã¾ã™ã€‚  
æ¨™æº–ã‚¨ãƒ©ãƒ¼ã ã¨ JSON ã§ã¯ãªãã€ãŸã ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã¤ã‚‰ã¤ã‚‰å‡ºã¦ã—ã¾ã†ã®ã§ã€æ”¹è¡Œã¨ç©ºç™½ã‚’å‰Šé™¤ã—1è¡Œã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚è‹¦è‚‰ã®ç­–ã§ã™ã€‚  

```yaml
    scrapeConfigs: |
      - job_name: kubernetes-pods
        pipeline_stages:
          - match:
              selector: '{container="php-demo"}'
              stages:
                - docker: {}
                - multiline:
                    firstline: '^\x{007B}'
                    timeout: 3s
                - replace:
                    expression: '(\n)'
                    replace: ""
                - replace:
                    expression: '(\s)'
                    replace: ""
```

### Grafana

ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è¨­å®šã‹ã‚‰ Loki ã¨ Tempo ã‚’æŠœãå‡ºã—ã¾ã—ãŸã€‚  
ã“ã†ã—ã¦ãŠãã¨ Grafana ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã•ã›ãŸéš›ã«è©²å½“ã®ãƒ­ã‚°ã¨ãƒªãƒ³ã‚¯ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  

```yaml
datasources: 
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki:3100
      jsonData:
        timeout: 60
        maxLines: 1000
        derivedFields:
          # Field with internal link pointing to data source in Grafana.
          # datasourceUid value can be anything, but it should be unique across all defined data source uids.
          - datasourceUid: tempo
            matcherRegex: "traceID=(\\w+)"
            name: TraceID
            # url will be interpreted as query for the datasource
            url: '$${__value.raw}'
            # optional for URL Label to set a custom display label for the link.
            urlDisplayLabel: 'View Trace'
    - name: tempo
      type: tempo
      url: http://tempo:3100
      isDefault: false
      access: proxy
      basicAuth: false
      jsonData:
        tracesToLogsV2:
          # Field with an internal link pointing to a logs data source in Grafana.
          # datasourceUid value must match the uid value of the logs data source.
          datasourceUid: 'Loki'
          spanStartTimeShift: '1h'
          spanEndTimeShift: '-1h'
          tags: [
            { key: 'app'}
          ]
          filterByTraceID: false
          filterBySpanID: true
          customQuery: false
```

## å‚è€ƒ

[A language-specific implementation of OpenTelemetry in PHP](https://opentelemetry.io/docs/languages/php/)  
[Quick start for Tempo](https://grafana.com/docs/tempo/latest/getting-started/docker-example/)  
[Grafana Loki documentation](https://grafana.com/docs/loki/latest/)  
[Promtail agent](https://grafana.com/docs/loki/latest/send-data/promtail/)  
