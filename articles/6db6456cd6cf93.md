---
title: "DMARCãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æãƒ»å¯è¦–åŒ–ã™ã‚‹ parsedmarc cli ã‚’ä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸ“§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["DMARC", "parsedmarc"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€‚  
ã”æ©Ÿå«Œã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚  
"No human labor is no human error" ãŒå¤§å¥½ããª[å‰äº• äº®](https://twitter.com/YoshiiRyo1)ã§ã™ã€‚  

DMARC å¯¾å¿œã—ã¦ã„ã¾ã™ã‹ï¼Ÿ  
å‰å›ã¯ [parsedmarc](https://domainaware.github.io/parsedmarc/) ã‚’ä½¿ã£ã¦ DMARC ãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æãƒ»å¯è¦–åŒ–ã—ã¾ã—ãŸã€‚  

@[card](https://zenn.dev/ryoyoshii/articles/8c4b7eb32ac59d)  

ä»Šå›ã¯ parsedmarc cli ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚  
Grafana ã§ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã«ãªã‚‹ä»£ã‚ã‚Šã« csv/json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚  

## CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Installation](https://domainaware.github.io/parsedmarc/installation.html) ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€
ãƒ­ãƒ¼ã‚«ãƒ«æ±šã—ãŸããªã„æ°—æŒã¡ãŒã‚ã‚‹ã®ã§ã€docker compose ã‚’ä½¿ã„ã¾ã™ã€‚  

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ã“ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚  

```bash
$ tree
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ input
â”‚   â””â”€â”€ example.xml
â”œâ”€â”€ output
â””â”€â”€ parsedmarc.ini
```

#### Dockerfile

```Dockerfile
FROM python:3.9.18-alpine3.19

RUN apk add --update --no-cache libxml2-dev libxslt-dev build-base libffi-dev \
    && pip install parsedmarc msgraph-core==0.2.2
```

#### docker-compose.yml

```yaml:docker-compose.yml
version: '3.5'
services:
  parsedmarc:
    build: .
    volumes:
      - ./input:/input:ro
      - ./output:/output
      - ./parsedmarc.ini:/parsedmarc.ini:ro
    command: parsedmarc -c /parsedmarc.ini /input/* --debug
```

#### parsedmarc.ini

ini ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸å¼ã¯ [Using parsedmarc](https://domainaware.github.io/parsedmarc/usage.html) ã‚’å‚ç…§ãã ã•ã„ã€‚  

```ini:parsedmarc.ini
[general]
save_aggregate = False
save_forensic = False
output = /output/
```

## å®Ÿè¡Œ

input ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã« DMARC ãƒ¬ãƒãƒ¼ãƒˆã‚’é…ç½®ã—ã¾ã™ã€‚æœ¬ã‚¨ãƒ³ãƒˆãƒªã®ä¾‹ã§ã¯ example.xml ã¨ãªã£ã¦ã„ã¾ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä½•ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚  

DMARC ãƒ¬ãƒãƒ¼ãƒˆé…ç½®ãŒçµ‚ã‚ã£ãŸã‚‰ã€docker compose ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  

```bash
$ docker-compose up 
[+] Building 0.0s (0/0)                                                                                                                                                                                                                                                                                            docker:desktop-linux
[+] Running 1/0
 âœ” Container cli-parsedmarc-1  Created                                                                                                                                                                                                                                                                                             0.0s 
Attaching to cli-parsedmarc-1
cli-parsedmarc-1  |     INFO:cli.py:802:Starting parsedmarc
cli-parsedmarc-1  |    DEBUG:__init__.py:952:Parsing /input/example.xml
cli-parsedmarc-1 exited with code 0

$ docker-compose rm
```

exit 0 ã§çµ‚ã‚ã£ã¦ã„ã‚Œã°æ­£å¸¸çµ‚äº†ã§ã™ã€‚output ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã« csv/json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚  

## CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹

xml ã‹ã‚‰ csv ã«å¤‰æ›ã•ã‚Œã¦å°‘ã—èª­ã¿ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚  
ç§ã®æ•™ç§‘æ›¸ã¨ã‚‚è¨€ãˆã‚‹ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’è¦‹ãªãŒã‚‰ csv ã‚’ç†è§£ã—ã¦ã„ãã¾ã™ã€‚  
@[card](https://baremail.jp/blog/2023/11/28/3595/)  
@[card](https://www.naritai.jp/guidance_record.html)  

| CSVã®åˆ—å                | èª¬æ˜                                                       |
| ------------------------ | ---------------------------------------------------------- |
| xml_schema               |                                                            |
| org_name                 | ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ã®åç§° (ãƒ¡ãƒ¼ãƒ«å—ä¿¡å´)                            |
| org_email                |                                                            |
| org_extra_contact_info   |                                                            |
| report_id                | ãƒ¬ãƒãƒ¼ãƒˆID                                                 |
| begin_date               | é›†è¨ˆæœŸé–“                                                   |
| end_date                 | é›†è¨ˆæœŸé–“                                                   |
| errors                   |                                                            |
| domain                   |                                                            |
| adkim                    | DKIM èªè¨¼è­˜åˆ¥å­ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã€r=relaxed, s=strict   |
| aspf                     | SPF èªè¨¼è­˜åˆ¥å­ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã€r=relaxed, s=strict    |
| p                        | DMARC ãƒãƒªã‚·ãƒ¼ (none, quarantine, reject)                  |
| sp                       | ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã™ã‚‹ãƒãƒªã‚·ãƒ¼                               |
| pct                      | DMARC ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã®å‰²åˆ                       |
| fo                       | å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã™ã‚‹æ¡ä»¶                                 |
| source_ip_address        | é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹                         |
| source_country           |                                                            |
| source_reverse_dns       |                                                            |
| source_base_domain       |                                                            |
| count                    | é›†è¨ˆæœŸé–“ã«é€ä¿¡ã•ã‚ŒãŸå›æ•°                                   |
| spf_aligned              | SPF ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã®çµæœ                                     |
| dkim_aligned             | DKIM ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã®çµæœ                                    |
| dmarc_aligned            | DMARC ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã®çµæœ                                   |
| disposition              | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é©ç”¨ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ï¼ˆnone, quarantine, rejectï¼‰ |
| policy_override_reasons  |                                                            |
| policy_override_comments |                                                            |
| envelope_from            | ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ— From                                          |
| header_from              | ãƒ¡ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ From                                          |
| envelope_to              |                                                            |
| dkim_domains             |                                                            |
| dkim_selectors           |                                                            |
| dkim_results             | DKIM èªè¨¼çµæœ                                              |
| spf_domains              |                                                            |
| spf_scopes               | SPF èªè¨¼å¯¾è±¡ã€‚mfrom = ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—Fromã€pra = ãƒ˜ãƒƒãƒ€From   |
| spf_results              | ä¸‹ SPF èªè¨¼çµæœ ã‚’å‚ç…§                                     |

SPF èªè¨¼ã€SPF ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã€DKIM èªè¨¼ã€DKIM ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ ã‚’ç¢ºèªã—ã¦ã©ã“ã«å•é¡ŒãŒã‚ã‚‹ã‹æŠŠæ¡ã—ã€å¯¾ç­–ã‚’è¡Œã„ã¾ã™ã€‚  
ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ— From ã¨ãƒ˜ãƒƒãƒ€ From ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã€ä¸€è‡´ã—ã¦ã„ãªãã¦ã‚‚ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ— From ã§ SPF ã¨ DKIM èªè¨¼ã‚’ãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹ãªã©ã‚’èª¿æŸ»ã—ã¾ã™ã€‚  

ãƒ™ã‚¢ãƒ¡ãƒ¼ãƒ«ã•ã‚“ã®ã‚µã‚¤ãƒˆãŒè©³ã—ã„ã§ã™ã€‚æ„Ÿè¬ã€‚  
@[card](https://baremail.jp/blog/2023/09/26/3474/)  

## SPF èªè¨¼çµæœ

ä¸€èˆ¬çš„ãªæ„å‘³ã§ã¯ãªãã€parsedmarc ã®å‡ºåŠ›çµæœã§ã®æ„å‘³ã§ã™ã€‚  

| å€¤        | èª¬æ˜                                   |
| --------- | -------------------------------------- |
| none      | SPF ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã®ã§èªè¨¼ã¯å¤±æ•— |
| pass      | SPF èªè¨¼ã«åˆæ ¼                         |
| hardfail  | å—ä¿¡å´ã§ç ´æ£„                           |
| softfail  | å—ä¿¡å´ã«å±ŠããŒã€ã‚¹ãƒ‘ãƒ åˆ¤å®šã•ã‚Œã‚‹å¯èƒ½æ€§ |
| neutral   | èªè¨¼çµæœã«é–¢ã‚ã‚‰ãšä½•ã‚‚ã—ãªã„           |
| temperror | ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ã§èªè¨¼ãŒå¤±æ•—ã—ã¦ã„ã‚‹     |
| permerror | æ§˜ã€…ãªè¦å› ã§èªè¨¼ãŒå¤±æ•—ã—ã¦ã„ã‚‹         |


## å‚è€ƒ

[DMARCãƒ¬ãƒãƒ¼ãƒˆã¨ã¯ï¼Ÿ è¨­å®šæ–¹æ³•ã‚„é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿æ–¹ã€è§£æãƒ„ãƒ¼ãƒ«ã‚’è§£èª¬](https://baremail.jp/blog/2023/11/28/3595/)  
[ãªãœSPFèªè¨¼ãŒå¤±æ•—ã™ã‚‹ã®ã§ã™ã‹ï¼ŸSPFèªè¨¼ã®å¤±æ•—ã‚’ä¿®æ­£ã™ã‚‹ã«ã¯ï¼Ÿ](https://powerdmarc.com/ja/why-spf-authentication-fails/)  
[DMARC è©³ç´°ä»•æ§˜-2](https://www.naritai.jp/guidance_record.html)  
[DMARCã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆï¼šç·©ã‚„ã‹ãªã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã¨å³æ ¼ãªã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰](https://powerdmarc.com/ja/dmarc-alignment/)  
